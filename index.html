<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory & Billing (Firebase)</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    .thermal .bill {
      width: 58mm; /* change to 80mm if needed */
      font-family: ui-monospace, monospace;
    }
    .thermal .bill * { line-height: 1.2; }
    .normal .bill { width: 100%; max-width: 700px; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>

  <!-- Firebase v9 compat -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>

<body class="bg-gray-100 min-h-screen">
  <!-- Login (VISIBLE by default to avoid blank screen) -->
  <section id="authView" class="max-w-md mx-auto p-6 mt-16 bg-white rounded-xl shadow">
    <h1 class="text-2xl font-bold mb-4">Login</h1>
    <div class="space-y-2">
      <input id="email" type="email" placeholder="Email" class="w-full border p-2 rounded" />
      <input id="password" type="password" placeholder="Password" class="w-full border p-2 rounded" />
      <button id="loginBtn" class="w-full py-2 bg-blue-600 text-white rounded">Sign in</button>
      <p id="authError" class="text-xs text-red-600 hidden"></p>
    </div>
  </section>

  <!-- App -->
  <section id="appView" class="p-4 max-w-7xl mx-auto hidden">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-semibold">Inventory & Billing</h2>
        <p id="userBadge" class="text-sm text-gray-600"></p>
      </div>
      <div class="flex items-center gap-2">
        <button id="logoutBtn" class="px-3 py-1 border rounded">Logout</button>
      </div>
    </header>

    <div class="grid md:grid-cols-3 gap-4">
      <!-- Dashboard -->
      <section class="md:col-span-2 bg-white p-4 rounded-xl shadow">
        <h3 class="font-semibold mb-3">Dashboard</h3>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Total Sales</div><div id="totalSales" class="text-lg font-bold">₹0.00</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Today's Sales</div><div id="todaysSales" class="text-lg font-bold">₹0.00</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Products</div><div id="productCount" class="text-lg font-bold">0</div></div>
        </div>

        <!-- Billing -->
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-medium">Billing</h4>
            <div class="text-sm text-gray-500">
              Payment:
              <select id="paymentMode" class="border rounded p-1">
                <option value="cash">Cash</option>
                <option value="online">Online</option>
              </select>
            </div>
          </div>
          <div id="billLines" class="mt-3 space-y-2"></div>
          <div class="flex gap-2 items-center mt-2">
            <button id="addLineBtn" class="px-3 py-1 border rounded">Add item</button>
            <input id="discount" type="number" min="0" step="0.01" placeholder="Discount" class="w-32 p-2 border rounded" />
            <button id="createBillBtn" class="ml-auto px-4 py-2 bg-green-600 text-white rounded">Create Bill</button>
            <button id="printBillBtn" class="px-3 py-2 border rounded">Print</button>
          </div>
        </div>
      </section>

      <!-- Inventory + Settings -->
      <aside class="bg-white p-4 rounded-xl shadow space-y-4">
        <div class="flex items-center justify-between">
          <h4 class="font-semibold">Inventory</h4>
          <span id="printModeChip" class="text-xs px-2 py-1 rounded bg-gray-100 border">print: -</span>
        </div>
        <ul id="inventoryList" class="mt-3 max-h-96 overflow-auto divide-y"></ul>

        <!-- Add Product (for any signed-in user) -->
        <div id="addProductBox" class="mt-4">
          <h5 class="font-medium mb-2">Add Product</h5>
          <div class="space-y-2">
            <input id="pSku" placeholder="SKU" class="w-full p-2 border rounded" />
            <input id="pName" placeholder="Product name" class="w-full p-2 border rounded" />
            <div class="grid grid-cols-3 gap-2">
              <input id="pQty" type="number" min="0" placeholder="Qty" class="p-2 border rounded" />
              <input id="pCost" type="number" min="0" step="0.01" placeholder="Cost" class="p-2 border rounded" />
              <input id="pPrice" type="number" min="0" step="0.01" placeholder="Price" class="p-2 border rounded" />
            </div>
            <label class="flex items-center gap-2 text-sm"><input id="pInfinite" type="checkbox" /> Infinite stock</label>
            <button id="addProductBtn" class="w-full py-2 bg-indigo-600 text-white rounded">Add Product</button>
          </div>
        </div>

        <!-- Store Settings (shared across all users) -->
        <div id="storeSettings" class="mt-6">
          <h5 class="font-semibold mb-2">Store Settings (Shared)</h5>
          <div class="space-y-2">
            <input id="storeName" class="w-full p-2 border rounded" placeholder="Store Name" />
            <textarea id="storeAddress" class="w-full p-2 border rounded" rows="2" placeholder="Address"></textarea>
            <input id="storeContact" class="w-full p-2 border rounded" placeholder="Contact (phone/email)" />
            <input id="logoUrl" class="w-full p-2 border rounded" placeholder="Logo URL (optional)" />
            <div class="grid grid-cols-2 gap-2">
              <input id="gstNumber" class="w-full p-2 border rounded" placeholder="GST Number (optional)" />
              <input id="taxPercent" type="number" class="w-full p-2 border rounded" placeholder="Tax % (e.g. 18)" />
            </div>
            <label class="flex items-center gap-2 text-sm">
              <input id="includeTax" type="checkbox" />
              Prices include Tax (GST)
            </label>
            <label class="text-sm">Print Mode</label>
            <select id="printMode" class="w-full p-2 border rounded">
              <option value="thermal">Thermal</option>
              <option value="normal">Normal</option>
            </select>
            <button id="saveSettingsBtn" class="w-full py-2 bg-gray-800 text-white rounded">Save Settings</button>
            <p id="settingsInfo" class="text-xs text-gray-500"></p>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- Print Area -->
  <div id="printArea" class="p-4">
    <div id="billContainer" class="bill mx-auto bg-white p-4 rounded shadow"></div>
  </div>

<script>
/* ----------------------- Firebase Setup ----------------------- */
const firebaseConfig = {
 apiKey: "AIzaSyCBN5AMN7j_qnlnwulFHvIeR1NmLyQ0OZo",
    authDomain: "techverse-ca88a.firebaseapp.com",
    databaseURL: "https://techverse-ca88a-default-rtdb.firebaseio.com",
    projectId: "techverse-ca88a",
    storageBucket: "techverse-ca88a.firebasestorage.app",
    messagingSenderId: "288969741715",
    appId: "1:288969741715:web:03ddb8b82da9224e234466",
    measurementId: "G-33XTL4HJR9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ----------------------- Helpers & State ----------------------- */
const $ = (id)=>document.getElementById(id);
function currency(n){return `₹${(Number(n)||0).toFixed(2)}`;}
function todayStart(){ const d=new Date(); return new Date(d.getFullYear(), d.getMonth(), d.getDate()); }

let settingsDoc={
  storeName:'',storeAddress:'',storeContact:'',
  logoUrl:'',gstNumber:'',taxPercent:0,
  includeTax:false, printMode:'thermal'
};
let products=[], sales=[];

/* ----------------------- Auth UI ----------------------- */
$('loginBtn').onclick=async()=>{
  $('authError').classList.add('hidden');
  try{
    await auth.signInWithEmailAndPassword($('email').value.trim(), $('password').value.trim());
  }catch(e){
    $('authError').textContent=e.message;
    $('authError').classList.remove('hidden');
  }
};
$('logoutBtn').onclick=()=>auth.signOut();

/* ----------------------- Auth State ----------------------- */
auth.onAuthStateChanged(async(u)=>{
  if(!u){
    // show login, hide app
    $('authView').classList.remove('hidden');
    $('appView').classList.add('hidden');
    return;
  }
  $('authView').classList.add('hidden');
  $('appView').classList.remove('hidden');
  $('userBadge').textContent = u.email;

  // Ensure settings doc exists
  const sRef = db.collection('meta').doc('settings');
  const sSnap = await sRef.get().catch(()=>null);
  if(!sSnap || !sSnap.exists){
    await sRef.set({
      storeName:'Your Store',
      storeAddress:'',
      storeContact:'',
      logoUrl:'',
      gstNumber:'',
      taxPercent:0,
      includeTax:false,
      printMode:'thermal'
    },{merge:true});
  }

  // Listen settings
  sRef.onSnapshot((snap)=>{
    if(snap.exists){
      settingsDoc = {...settingsDoc, ...snap.data()};
      updateSettingsUI();
    }
  }, console.error);

  // Listen products (safe query; no 'where' that can cause blank)
  db.collection('products').onSnapshot(q=>{
    products = q.docs
      .map(d=>({id:d.id, ...d.data()}))
      .filter(p=>!p.deleted);
    renderInventory();
    rebuildBillOptions();
    $('productCount').textContent = products.length;
  }, console.error);

  // Listen sales
  db.collection('sales').orderBy('createdAt','desc').limit(500).onSnapshot(q=>{
    sales = q.docs.map(d=>({id:d.id, ...d.data()}));
    renderDashboard();
  }, console.error);
});

/* ----------------------- Settings UI ----------------------- */
function updateSettingsUI(){
  $('storeName').value     = settingsDoc.storeName || '';
  $('storeAddress').value  = settingsDoc.storeAddress || '';
  $('storeContact').value  = settingsDoc.storeContact || '';
  $('logoUrl').value       = settingsDoc.logoUrl || '';
  $('gstNumber').value     = settingsDoc.gstNumber || '';
  $('taxPercent').value    = settingsDoc.taxPercent || 0;
  $('includeTax').checked  = !!settingsDoc.includeTax;
  $('printMode').value     = settingsDoc.printMode || 'thermal';

  const area = $('printArea');
  area.classList.remove('thermal','normal');
  area.classList.add(settingsDoc.printMode);
  $('printModeChip').textContent = `print: ${settingsDoc.printMode}`;
}

$('saveSettingsBtn').onclick=async()=>{
  const data={
    storeName:$('storeName').value.trim(),
    storeAddress:$('storeAddress').value.trim(),
    storeContact:$('storeContact').value.trim(),
    logoUrl:$('logoUrl').value.trim(),
    gstNumber:$('gstNumber').value.trim(),
    taxPercent: Number($('taxPercent').value) || 0,
    includeTax: $('includeTax').checked,
    printMode: $('printMode').value
  };
  await db.collection('meta').doc('settings').set(data,{merge:true});
  $('settingsInfo').textContent='Saved ✓';
  setTimeout(()=>$('settingsInfo').textContent='',1500);
};

/* ----------------------- Inventory ----------------------- */
function renderInventory(){
  const list=$('inventoryList');
  list.innerHTML='';
  products.forEach(p=>{
    const li=document.createElement('li');
    li.className='py-2 flex items-start justify-between gap-2';
    li.innerHTML=`
      <div>
        <div class="font-medium">${p.name||'-'} ${p.infinite?'<span class="text-xs text-green-600">(Infinite)</span>':''}</div>
        <div class="text-xs text-gray-500">SKU: ${p.sku||'-'} • Qty: ${p.infinite?'∞':(p.quantity??0)} • Price: ${currency(p.price||0)}</div>
      </div>
      <div class="flex gap-2">
        <button class="px-2 py-1 text-xs border rounded" data-action="plus10" data-id="${p.id}">+10</button>
        <button class="px-2 py-1 text-xs border rounded" data-action="toggleInf" data-id="${p.id}">${p.infinite?'Finite':'Infinite'}</button>
        <button class="px-2 py-1 text-xs border rounded" data-action="delete" data-id="${p.id}">Delete</button>
      </div>
    `;
    list.appendChild(li);
  });
}

$('addProductBtn').onclick=async()=>{
  const p={
    sku: $('pSku').value.trim(),
    name: $('pName').value.trim(),
    quantity: Number($('pQty').value||0),
    cost: Number($('pCost').value||0),
    price: Number($('pPrice').value||0),
    infinite: $('pInfinite').checked,
    deleted:false,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  };
  if(!p.name) return alert('Product name required');
  await db.collection('products').add(p);
  $('pSku').value='';$('pName').value='';$('pQty').value='';$('pCost').value='';$('pPrice').value='';
  $('pInfinite').checked=false;
};

$('inventoryList').addEventListener('click', async (e)=>{
  const btn=e.target.closest('button'); if(!btn) return;
  const id=btn.dataset.id; const action=btn.dataset.action; if(!id) return;
  const ref=db.collection('products').doc(id);
  if(action==='plus10') await ref.update({quantity: firebase.firestore.FieldValue.increment(10)});
  if(action==='toggleInf'){
    const snap=await ref.get(); const inf=!!(snap.data()||{}).infinite;
    await ref.update({infinite: !inf});
  }
  if(action==='delete') await ref.update({deleted:true});
});

/* ----------------------- Billing ----------------------- */
const billLinesEl=$('billLines');
function rebuildBillOptions(){
  [...billLinesEl.querySelectorAll('select.prodSel')].forEach(sel=>{
    const val=sel.value;
    sel.innerHTML = `<option value="">Select product</option>` +
      products.map(p=>`<option value="${p.id}" ${p.id===val?'selected':''}>${p.name} — ${currency(p.price||0)}</option>`).join('');
  });
}
function addLine(){
  const wrap=document.createElement('div');
  wrap.className='flex gap-2';
  wrap.innerHTML=`
    <select class="prodSel p-2 border rounded flex-1">
      <option value="">Select product</option>
      ${products.map(p=>`<option value="${p.id}">${p.name} — ${currency(p.price||0)}</option>`).join('')}
    </select>
    <input type="number" class="qtySel w-24 p-2 border rounded" min="1" value="1" />
    <button class="rmLine px-2 py-1 border rounded">Remove</button>
  `;
  billLinesEl.appendChild(wrap);
}
$('addLineBtn').onclick=addLine;
addLine();

billLinesEl.addEventListener('click',(e)=>{
  if(e.target.classList.contains('rmLine')){
    e.target.closest('div').remove();
  }
});

$('createBillBtn').onclick=async()=>{
  // collect items
  const items=[...billLinesEl.querySelectorAll('div')].map(row=>{
    const pid=row.querySelector('select.prodSel').value;
    const qty=Number(row.querySelector('input.qtySel').value||0);
    const p=products.find(x=>x.id===pid)||{};
    return (pid && qty>0)?{productId:pid,name:p.name,qty,price:Number(p.price||0),cost:Number(p.cost||0),infinite:!!p.infinite}:null;
  }).filter(Boolean);
  if(!items.length) return alert('Add at least one item');

  const discount = Number($('discount').value || 0);
  const paymentMode = $('paymentMode').value;

  // Calculate totals with includeTax option
  const subtotalRaw = items.reduce((a,b)=> a + (b.qty*b.price), 0);
  let subtotal = subtotalRaw; // shown as "Subtotal (before discount)"
  let taxAmt = 0;
  let total = 0;

  const taxPct = Number(settingsDoc.taxPercent||0);

  if(settingsDoc.includeTax){
    // Prices already include GST
    // tax portion extracted from subtotal (before discount)
    taxAmt = taxPct>0 ? (subtotal * (taxPct / (100 + taxPct))) : 0;
    // Total is still subtotal - discount (tax already included in subtotal)
    total = Math.max(0, subtotal - discount);
  }else{
    // Prices exclude GST
    const taxableBase = Math.max(0, subtotal - discount);
    taxAmt = taxPct>0 ? (taxableBase * taxPct / 100) : 0;
    total = taxableBase + taxAmt;
  }

  // write sale
  const saleRef = await db.collection('sales').add({
    items, subtotal, discount, taxPercent: taxPct, taxAmt, total, paymentMode,
    includeTax: !!settingsDoc.includeTax,
    createdAt: firebase.firestore.FieldValue.serverTimestamp()
  });

  // decrement stock for finite items
  for(const it of items){
    if(it.infinite) continue;
    const ref=db.collection('products').doc(it.productId);
    await ref.update({quantity: firebase.firestore.FieldValue.increment(-it.qty)});
  }

  renderBill({id:saleRef.id, items, subtotal, discount, taxAmt, total, paymentMode});
  alert('Invoice created: '+saleRef.id);
};

$('printBillBtn').onclick=()=>window.print();

function renderBill({id, items, subtotal, discount, taxAmt, total, paymentMode}){
  const el=$('billContainer');
  const date=new Date().toLocaleString();
  el.innerHTML = `
    <div class="text-center">
      ${settingsDoc.logoUrl ? `<img src="${settingsDoc.logoUrl}" alt="logo" class="mx-auto mb-2 max-h-12"/>` : ''}
      <div class="font-bold">${settingsDoc.storeName||'Your Store'}</div>
      ${settingsDoc.storeAddress?`<div class="text-xs">${settingsDoc.storeAddress}</div>`:''}
      ${settingsDoc.storeContact?`<div class="text-xs">${settingsDoc.storeContact}</div>`:''}
      ${settingsDoc.gstNumber?`<div class="text-xs">GST: ${settingsDoc.gstNumber}</div>`:''}
      <div class="text-xs">Invoice #${(id||'').slice(-8)} • ${date} • Payment: ${paymentMode}</div>
    </div>
    <hr class="my-2" />
    <table class="w-full text-sm">
      <thead><tr><th class="text-left">Item</th><th class="text-right">Qty</th><th class="text-right">Price</th><th class="text-right">Amt</th></tr></thead>
      <tbody>
        ${items.map(it=>`<tr>
          <td>${it.name||'-'}</td>
          <td class="text-right">${it.qty}</td>
          <td class="text-right">${(it.price||0).toFixed(2)}</td>
          <td class="text-right">${(it.qty*(it.price||0)).toFixed(2)}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <hr class="my-2" />
    <div class="flex justify-between text-sm"><span>Subtotal</span><span>${currency(subtotal)}</span></div>
    <div class="flex justify-between text-sm"><span>Discount</span><span>${currency(discount)}</span></div>
    <div class="flex justify-between text-sm"><span>Tax ${settingsDoc.includeTax?'(incl.)':''} (${settingsDoc.taxPercent||0}%)</span><span>${currency(taxAmt)}</span></div>
    <div class="flex justify-between font-bold"><span>Total</span><span>${currency(total)}</span></div>
    <div class="text-center text-xs mt-2">Thank you!</div>
  `;
}

/* ----------------------- Dashboard ----------------------- */
function renderDashboard(){
  const t0 = sales.reduce((a,b)=> a + (b.total||0), 0);
  $('totalSales').textContent = currency(t0);

  const start = todayStart();
  const ts = sales.filter(s => s.createdAt && s.createdAt.toDate && s.createdAt.toDate() >= start)
                  .reduce((a,b)=> a + (b.total||0), 0);
  $('todaysSales').textContent = currency(ts);
}
</script>
</body>
</html>
