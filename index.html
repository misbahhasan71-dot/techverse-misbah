<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Inventory & Billing (Firebase)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .thermal .bill {
      width: 58mm;
      font-family: ui-monospace, Menlo, Consolas, "Courier New", monospace;
    }
    .thermal .bill * { line-height: 1.2; }
    .normal .bill { width: 100%; max-width: 700px; }

    @media print {
      body * { visibility: hidden; }
      #printArea, #printArea * { visibility: visible; }
      #printArea { position: absolute; left: 0; top: 0; width: 100%; }
    }
  </style>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
  <!-- Login -->
  <section id="authView" class="max-w-md mx-auto p-6 mt-16 bg-white rounded-xl shadow hidden">
    <h1 class="text-2xl font-bold mb-4">Login</h1>
    <div class="space-y-2">
      <input id="email" type="email" placeholder="Email" class="w-full border p-2 rounded" />
      <input id="password" type="password" placeholder="Password" class="w-full border p-2 rounded" />
      <button id="loginBtn" class="w-full py-2 bg-blue-600 text-white rounded">Sign in</button>
      <p class="text-xs text-gray-500 text-center">Only registered Firebase users can log in.</p>
    </div>
  </section>

  <!-- App -->
  <section id="appView" class="p-4 max-w-7xl mx-auto hidden">
    <header class="flex items-center justify-between mb-4">
      <div>
        <h2 class="text-xl font-semibold" id="storeName" contenteditable="true" onblur="saveStoreDetail('storeName', this.textContent)">
          Techverse Solutions
        </h2>
        <p id="storeAddress" contenteditable="true" onblur="saveStoreDetail('storeAddress', this.textContent)" class="text-sm text-gray-500">
          Patel Nagar, Fatehpur 212601
        </p>
        <p id="storeContact" contenteditable="true" onblur="saveStoreDetail('storeContact', this.textContent)" class="text-sm text-gray-500">
          +91 8948581236
        </p>
      </div>
      <div class="flex items-center gap-2">
        <p id="userBadge" class="text-sm text-gray-600"></p>
        <button id="logoutBtn" class="px-3 py-1 border rounded">Logout</button>
      </div>
    </header>

    <div class="grid md:grid-cols-3 gap-4">
      <!-- Dashboard -->
      <section class="md:col-span-2 bg-white p-4 rounded-xl shadow">
        <h3 class="font-semibold mb-3">Dashboard</h3>
        <div class="grid grid-cols-3 gap-3">
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Total Sales</div><div id="totalSales" class="text-lg font-bold">₹0.00</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Today's Sales</div><div id="todaysSales" class="text-lg font-bold">₹0.00</div></div>
          <div class="p-3 border rounded"><div class="text-xs text-gray-500">Products</div><div id="productCount" class="text-lg font-bold">0</div></div>
        </div>

        <!-- Billing -->
        <div class="mt-6">
          <div class="flex items-center justify-between">
            <h4 class="font-medium">Billing</h4>
            <div class="text-sm text-gray-500">Payment: 
              <select id="paymentMode" class="border rounded p-1">
                <option value="cash">Cash</option>
                <option value="online">Online</option>
              </select>
            </div>
          </div>
          <div id="billLines" class="mt-3 space-y-2"></div>
          <div class="flex gap-2 items-center mt-2">
            <button id="addLineBtn" class="px-3 py-1 border rounded">Add item</button>
            <input id="discount" type="number" min="0" step="0.01" placeholder="Discount" class="w-32 p-2 border rounded" />
            <button id="createBillBtn" class="ml-auto px-4 py-2 bg-green-600 text-white rounded">Create Bill</button>
            <button id="printBillBtn" class="px-3 py-2 border rounded">Print</button>
          </div>
        </div>
      </section>

      <!-- Inventory -->
      <aside class="bg-white p-4 rounded-xl shadow">
        <div class="flex items-center justify-between">
          <h4 class="font-semibold">Inventory</h4>
        </div>
        <ul id="inventoryList" class="mt-3 max-h-96 overflow-auto divide-y"></ul>

        <!-- Allow ALL users to add -->
        <div id="adminAddProduct" class="mt-4">
          <h5 class="font-medium mb-2">Add Product</h5>
          <div class="space-y-2">
            <input id="pSku" placeholder="SKU" class="w-full p-2 border rounded" />
            <input id="pName" placeholder="Product name" class="w-full p-2 border rounded" />
            <div class="grid grid-cols-3 gap-2">
              <input id="pQty" type="number" min="0" placeholder="Qty" class="p-2 border rounded" />
              <input id="pCost" type="number" min="0" step="0.01" placeholder="Cost" class="p-2 border rounded" />
              <input id="pPrice" type="number" min="0" step="0.01" placeholder="Price" class="p-2 border rounded" />
            </div>
            <label class="flex items-center gap-2 text-sm"><input id="pInfinite" type="checkbox" /> Infinite stock</label>
            <button id="addProductBtn" class="w-full py-2 bg-indigo-600 text-white rounded">Add Product</button>
          </div>
        </div>
      </aside>
    </div>
  </section>

  <!-- Print area -->
  <div id="printArea" class="p-4">
    <div id="billContainer" class="bill mx-auto bg-white p-4 rounded shadow"></div>
  </div>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyCBN5AMN7j_qnlnwulFHvIeR1NmLyQ0OZo",
  authDomain: "techverse-ca88a.firebaseapp.com",
  projectId: "techverse-ca88a",
  storageBucket: "techverse-ca88a.firebasestorage.app",
  messagingSenderId: "288969741715",
  appId: "1:288969741715:web:03ddb8b82da9224e234466",
  measurementId: "G-33XTL4HJR9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

const $ = (id) => document.getElementById(id);
function currency(n){ return `₹${(Number(n)||0).toFixed(2)}`; }

let currentUserDoc = null;
let products = [];
let sales = [];

// ===== Login =====
$('loginBtn').addEventListener('click', async () => {
  try {
    await auth.signInWithEmailAndPassword($('email').value, $('password').value);
  } catch (e) { alert('Login failed: ' + e.message); }
});
$('logoutBtn').addEventListener('click', () => auth.signOut());

auth.onAuthStateChanged(async (u) => {
  if (!u) {
    $('authView').classList.remove('hidden');
    $('appView').classList.add('hidden');
    return;
  }
  $('authView').classList.add('hidden');
  $('appView').classList.remove('hidden');
  $('userBadge').textContent = u.email;

  db.collection('products').where('deleted','!=',true).onSnapshot((qs) => {
    products = qs.docs.map(d => ({ id: d.id, ...d.data() }));
    renderInventory();
    $('productCount').textContent = products.length;
    rebuildBillLinesOptions();
  });

  db.collection('sales').orderBy('createdAt','desc').onSnapshot((qs) => {
    sales = qs.docs.map(d => d.data());
    const total = sales.reduce((a,b)=>a+(b.total||0),0);
    $('totalSales').textContent = currency(total);
  });
});

// ===== Store Details =====
function saveStoreDetail(key, val){ localStorage.setItem(key, val); }
function getStoreDetail(key, def){ return localStorage.getItem(key)||def; }

// ===== Inventory =====
function renderInventory(){
  const list = $('inventoryList');
  list.innerHTML = '';
  products.forEach(p=>{
    const li=document.createElement('li');
    li.className='py-2 flex items-start justify-between gap-2';
    li.innerHTML=`
      <div>
        <div class="font-medium">${p.name}</div>
        <div class="text-xs text-gray-500">Qty: ${p.quantity||0} • ₹${p.price||0}</div>
      </div>
    `;
    list.appendChild(li);
  });
}

$('addProductBtn').addEventListener('click', async () => {
  const p = {
    sku:$('pSku').value, name:$('pName').value,
    quantity:Number($('pQty').value||0),
    cost:Number($('pCost').value||0),
    price:Number($('pPrice').value||0),
    infinite:$('pInfinite').checked,
    createdAt:firebase.firestore.FieldValue.serverTimestamp(),
  };
  if(!p.name) return alert('Enter name');
  await db.collection('products').add(p);
  $('pSku').value=$('pName').value=$('pQty').value=$('pCost').value=$('pPrice').value='';
});

// ===== Billing =====
const billLinesEl = $('billLines');
function addLine(){
  const div=document.createElement('div');
  div.className='flex gap-2';
  div.innerHTML=`
    <select class="prodSel p-2 border rounded flex-1">
      ${products.map(p=>`<option value="${p.id}">${p.name} ₹${p.price}</option>`).join('')}
    </select>
    <input type="number" class="qtySel w-24 p-2 border rounded" min="1" value="1" />
    <button class="rmLine px-2 border rounded">x</button>
  `;
  billLinesEl.appendChild(div);
}
$('addLineBtn').addEventListener('click', addLine);
addLine();

$('createBillBtn').addEventListener('click', async ()=>{
  const items=[...billLinesEl.querySelectorAll('div')].map(div=>{
    const id=div.querySelector('.prodSel').value;
    const qty=+div.querySelector('.qtySel').value;
    const p=products.find(x=>x.id===id)||{};
    return {name:p.name, qty, price:p.price, total:qty*p.price};
  }).filter(i=>i.name);
  const discount=+($('discount').value||0);
  const total=items.reduce((a,b)=>a+b.total,0)-discount;
  await db.collection('sales').add({
    items,total,discount,createdAt:firebase.firestore.FieldValue.serverTimestamp()
  });
  renderBill(items,total,discount);
});

function renderBill(items,total,discount){
  const el=$('billContainer');
  const name=getStoreDetail('storeName','Techverse Solutions');
  const addr=getStoreDetail('storeAddress','Patel Nagar, Fatehpur');
  const contact=getStoreDetail('storeContact','+91 8948581236');
  el.innerHTML=`
    <div class="text-center">
      <h2>${name}</h2>
      <p>${addr}</p><p>${contact}</p>
      <hr/>
      <table class="w-full text-sm"><tbody>
      ${items.map(i=>`<tr><td>${i.name}</td><td>${i.qty}</td><td>${i.price}</td><td>${i.total}</td></tr>`).join('')}
      </tbody></table>
      <hr/><p>Discount: ${discount}</p><h3>Total: ${total}</h3>
    </div>`;
}
$('printBillBtn').addEventListener('click',()=>window.print());
</script>
</body>
</html>
