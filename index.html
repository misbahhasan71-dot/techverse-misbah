<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Techverse Solution â€“ Inventory & Billing</title>

  <!-- Keep your original styles/layout -->
  <style>
    /* === your original CSS (unchanged) === */
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
    .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
    .login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,.2);max-width:400px;width:100%}
    .login-box h1{color:#2563eb;margin-bottom:10px;font-size:28px}
    .login-box p{color:#666;margin-bottom:30px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:#333;font-weight:500}
    .form-group input,.form-group select,.form-group textarea{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#2563eb}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s}
    .btn-primary{background:#2563eb;color:white}
    .btn-primary:hover{background:#1d4ed8;transform:translateY(-2px);box-shadow:0 5px 15px rgba(37,99,235,.3)}
    .btn-secondary{background:#6b7280;color:white}
    .btn-secondary:hover{background:#4b5563}
    .btn-success{background:#10b981;color:white}
    .btn-success:hover{background:#059669}
    .btn-danger{background:#ef4444;color:white}
    .btn-danger:hover{background:#dc2626}
    .btn-sm{padding:6px 12px;font-size:12px}
    .app-container{display:none;background:#f3f4f6;min-height:100vh}
    .header{background:white;padding:20px 30px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .header h1{color:#2563eb;font-size:24px}
    .header-right{display:flex;align-items:center;gap:15px}
    .user-info{color:#666;font-size:14px}
    .nav-tabs{background:white;padding:0 30px;display:flex;gap:5px;overflow-x:auto;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .nav-tab{padding:15px 20px;cursor:pointer;border:none;background:transparent;color:#666;font-weight:500;border-bottom:3px solid transparent;transition:all .3s;white-space:nowrap}
    .nav-tab:hover{color:#2563eb;background:#eff6ff}
    .nav-tab.active{color:#2563eb;border-bottom-color:#2563eb}
    .content{padding:30px;max-width:1400px;margin:0 auto}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card{background:white;border-radius:12px;padding:25px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
    .card h2{color:#1f2937;margin-bottom:20px;font-size:20px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:white;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(37,99,235,.3)}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%);box-shadow:0 4px 15px rgba(16,185,129,.3)}
    .stat-card.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);box-shadow:0 4px 15px rgba(245,158,11,.3)}
    .stat-card.purple{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);box-shadow:0 4px 15px rgba(139,92,246,.3)}
    .stat-label{font-size:14px;opacity:.9;margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:bold}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .search-box{margin-bottom:20px}
    .search-box input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    thead{background:#f3f4f6}
    th{padding:12px;text-align:left;color:#374151;font-weight:600;font-size:13px}
    td{padding:12px;border-bottom:1px solid #e5e7eb;color:#4b5563;font-size:14px}
    tr:hover{background:#f9fafb}
    .actions{display:flex;gap:8px}
    .toast{position:fixed;top:20px;right:20px;background:white;padding:15px 20px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2);display:none;z-index:1000;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-left:4px solid #10b981}
    .toast.error{border-left:4px solid #ef4444}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999;justify-content:center;align-items:center;padding:20px}
    .modal.active{display:flex}
    .modal-content{background:white;padding:30px;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h3{color:#1f2937;font-size:20px}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#9ca3af}
    .close-btn:hover{color:#374151}
    .pos-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    .product-select{margin-bottom:15px}
    .product-select select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px}
    .quantity-control{display:flex;align-items:center;gap:8px}
    .quantity-control button{width:28px;height:28px;border:none;background:#2563eb;color:white;border-radius:4px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
    .quantity-control span{min-width:30px;text-align:center}
    .low-stock{background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .invoice{max-width:800px;margin:0 auto;padding:40px;background:white}
    .invoice-header{text-align:center;border-bottom:2px solid #2563eb;padding-bottom:20px;margin-bottom:30px}
    .invoice-header h1{color:#2563eb;font-size:28px;margin-bottom:5px}
    .invoice-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    .chart-container{position:relative;height:300px;margin-top:20px}
    @media print{body *{visibility:hidden}.invoice,.invoice *{visibility:visible}.invoice{position:absolute;left:0;top:0;width:100%}.btn{display:none}}
    @media (max-width:768px){.pos-grid{grid-template-columns:1fr}.header h1{font-size:18px}.content{padding:15px}.nav-tabs{padding:0 15px}.form-row{grid-template-columns:1fr}table{font-size:12px}th,td{padding:8px 4px}}
    /* Print modes */
    .print-thermal .invoice{max-width:58mm;padding:10px}
    .print-thermal .invoice-header{border-bottom:1px dashed #999}
    .print-normal .invoice{max-width:800px}
  </style>
</head>
<body>
  <div id="toast" class="toast"></div>

  <!-- LOGIN (no sign up link) -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h1>Techverse Solution</h1>
      <p>Inventory & Billing System</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@example.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="********">
      </div>
<div class="form-group">
 
</div>
<button class="btn btn-primary" id="loginBtn">Login</button>

    </div>
  </div>

  <!-- APP -->
  <div id="appContainer" class="app-container">
    <div class="header">
      <h1>Techverse Solution â€“ Inventory & Billing</h1>
      <div class="header-right">
        <span class="user-info" id="userInfo"></span>
        <button class="btn btn-secondary btn-sm" onclick="openSettings()">Store Settings</button>
        <button class="btn btn-secondary btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab(event,'dashboard')">Dashboard</button>
      <button class="nav-tab" onclick="switchTab(event,'products')">Products</button>
      <button class="nav-tab" onclick="switchTab(event,'pos')">POS</button>
      <button class="nav-tab" onclick="switchTab(event,'customers')">Customers</button>
      <button class="nav-tab" onclick="switchTab(event,'reports')">Reports</button>
      <button class="nav-tab" onclick="switchTab(event,'export')">Export</button>
      <button class="nav-tab" onclick="switchTab(event,'import')">Import</button>
    </div>

    <div class="content">
      <!-- Dashboard -->
      <div id="dashboard" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><div class="stat-label">Total Products</div><div class="stat-value" id="totalProducts">0</div></div>
          <div class="stat-card green"><div class="stat-label">Total Customers</div><div class="stat-value" id="totalCustomers">0</div></div>
          <div class="stat-card orange"><div class="stat-label">Total Sales (â‚¹)</div><div class="stat-value" id="totalSales">0</div></div>
          <div class="stat-card purple"><div class="stat-label">Low Stock Items</div><div class="stat-value" id="lowStockCount">0</div></div>
        </div>

        <div class="card">
          <h2>Recent Transactions</h2>
          <table id="recentTransactionsTable">
            <thead><tr><th>Invoice #</th><th>Date</th><th>Customer</th><th>Total (â‚¹)</th><th>Actions</th></tr></thead>
            <tbody id="recentTransactions"></tbody>
          </table>
        </div>

        <div class="card">
          <h2>Low Stock Alerts</h2>
          <table>
            <thead><tr><th>Product</th><th>Category</th><th>Current Stock</th><th>SKU</th></tr></thead>
            <tbody id="lowStockTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Products -->
      <div id="products" class="tab-content">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="margin:0;">Product Management</h2>
            <button class="btn btn-primary" onclick="showAddProductModal()">Add Product</button>
          </div>
          <div class="search-box">
            <input type="text" id="productSearch" placeholder="Search products..." onkeyup="searchProducts()">
          </div>
          <table>
            <thead><tr><th>Name</th><th>Category</th><th>Quantity</th><th>Cost (â‚¹)</th><th>Selling (â‚¹)</th><th>Supplier</th><th>SKU</th><th>Actions</th></tr></thead>
            <tbody id="productsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- POS -->
      <div id="pos" class="tab-content">
        <div class="pos-grid">
          <div class="card">
            <h2>Select Products</h2>
            <div class="product-select">
              <select id="posProductSelect" onchange="addToCart()">
                <option value="">-- Select Product --</option>
              </select>
            </div>
            <table>
              <thead><tr><th>Product</th><th>Price (â‚¹)</th><th>Qty</th><th>Subtotal (â‚¹)</th><th>Actions</th></tr></thead>
              <tbody id="cartItems"></tbody>
            </table>
          </div>

          <div class="card">
            <h2>Billing Details</h2>
            <div class="form-group">
              <label>Customer Name</label>
              <input type="text" id="billCustomerName" placeholder="Customer name">
            </div>
            <div class="form-group">
              <label>Customer Phone</label>
              <input type="text" id="billCustomerPhone" placeholder="Phone number">
            </div>
            <div class="form-group">
              <label>Tax (%)</label>
              <input type="number" id="taxPercent" value="0" min="0" max="100" onchange="updateCart()">
            </div>
            <div class="form-group">
              <label>Discount (â‚¹)</label>
              <input type="number" id="discountAmount" value="0" min="0" onchange="updateCart()">
            </div>

            <div class="cart-total">
              <div class="total-row"><span>Subtotal:</span><span id="subtotal">â‚¹0</span></div>
              <div class="total-row"><span>Tax:</span><span id="taxAmount">â‚¹0</span></div>
              <div class="total-row"><span>Discount:</span><span id="discount">â‚¹0</span></div>
              <div class="total-row grand"><span>Grand Total:</span><span id="grandTotal">â‚¹0</span></div>
            </div>

            <div class="form-group">
              <label>Payment Mode</label>
              <select id="paymentMode">
                <option value="cash">Cash</option>
                <option value="online">Online</option>
              </select>
            </div>

            <div class="form-group">
              <label>Print Mode</label>
              <select id="printModeSelect" onchange="applyPrintModeSelect()">
                <option value="normal">Normal</option>
                <option value="thermal">Thermal</option>
              </select>
            </div>

            <button class="btn btn-success" style="width:100%;margin-top:20px;" onclick="completeSale()">Complete Sale</button>
            <button class="btn btn-secondary" style="width:100%;margin-top:10px;" onclick="clearCart()">Clear Cart</button>
          </div>
        </div>
      </div>

      <!-- Customers -->
      <div id="customers" class="tab-content">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="margin:0;">Customer Management</h2>
            <button class="btn btn-primary" onclick="showAddCustomerModal()">Add Customer</button>
          </div>
          <div class="search-box">
            <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
          </div>
          <table>
            <thead><tr><th>Name</th><th>Contact</th><th>Address</th><th>Total Purchases (â‚¹)</th><th>Actions</th></tr></thead>
            <tbody id="customersTable"></tbody>
          </table>
        </div>
      </div>

      <!-- Reports -->
      <div id="reports" class="tab-content">
        <div class="card">
          <h2>Sales Report</h2>
          <div class="chart-container"><div id="salesChart"></div></div>
        </div>
        <div class="card">
          <h2>Best Selling Products</h2>
          <table>
            <thead><tr><th>Product</th><th>Category</th><th>Units Sold</th><th>Revenue (â‚¹)</th></tr></thead>
            <tbody id="bestSellersTable"></tbody>
          </table>
        </div>
        <div class="card">
          <h2>Monthly Summary</h2>
          <div class="stats-grid">
            <div class="stat-card green"><div class="stat-label">This Month Revenue (â‚¹)</div><div class="stat-value" id="monthRevenue">0</div></div>
            <div class="stat-card"><div class="stat-label">This Month Transactions</div><div class="stat-value" id="monthTransactions">0</div></div>
            <div class="stat-card purple"><div class="stat-label">Average Sale (â‚¹)</div><div class="stat-value" id="avgSale">0</div></div>
          </div>
        </div>
      </div>

      <!-- Export -->
      <div id="export" class="tab-content">
        <div class="card">
          <h2>Export Data</h2>
          <p style="color:#666;margin-bottom:20px;">Download your data for backup or external use.</p>
          <div style="display:flex;gap:15px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="exportData('products','json')">Export Products (JSON)</button>
            <button class="btn btn-primary" onclick="exportData('products','csv')">Export Products (CSV)</button>
            <button class="btn btn-success" onclick="exportData('customers','json')">Export Customers (JSON)</button>
            <button class="btn btn-success" onclick="exportData('customers','csv')">Export Customers (CSV)</button>
            <button class="btn btn-secondary" onclick="exportData('transactions','json')">Export Transactions (JSON)</button>
            <button class="btn btn-secondary" onclick="exportData('transactions','csv')">Export Transactions (CSV)</button>
            <button class="btn btn-danger" onclick="exportData('all','json')">Export All Data (JSON)</button>
          </div>
        </div>
      </div>

      <!-- Import -->
      <div id="import" class="tab-content">
        <div class="card">
          <h2>Import Data</h2>
          <p style="color:#666;margin-bottom:20px;">Restore your data from previously exported files.</p>
          <div class="form-group">
            <label>Select Data Type</label>
            <select id="importType">
              <option value="products">Products</option>
              <option value="customers">Customers</option>
              <option value="transactions">Transactions</option>
              <option value="all">All Data</option>
            </select>
          </div>
          <div class="form-group">
            <label>Select File (JSON)</label>
            <input type="file" id="importFile" accept=".json">
          </div>
          <button class="btn btn-primary" onclick="importData()">Import Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modals -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="productModalTitle">Add Product</h3>
        <button class="close-btn" onclick="closeProductModal()">&times;</button>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Product Name *</label><input type="text" id="productName"></div>
        <div class="form-group"><label>Category *</label><input type="text" id="productCategory"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Quantity *</label><input type="number" id="productQuantity" min="0"></div>
        <div class="form-group"><label>Cost Price (â‚¹) *</label><input type="number" id="productCost" min="0" step="0.01"></div>
      </div>
      <div class="form-row">
        <div class="form-group"><label>Selling Price (â‚¹) *</label><input type="number" id="productSelling" min="0" step="0.01"></div>
        <div class="form-group"><label>Supplier</label><input type="text" id="productSupplier"></div>
      </div>
      <div class="form-group"><label>SKU/Barcode</label><input type="text" id="productSKU"></div>
      <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
    </div>
  </div>

  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="customerModalTitle">Add Customer</h3>
        <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
      </div>
      <div class="form-group"><label>Customer Name *</label><input type="text" id="customerName"></div>
      <div class="form-group"><label>Contact Number *</label><input type="text" id="customerContact"></div>
      <div class="form-group"><label>Address</label><textarea id="customerAddress" rows="3" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;"></textarea></div>
      <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Store Settings</h3>
        <button class="close-btn" onclick="closeSettings()">&times;</button>
      </div>
      <div class="form-group"><label>Store Name</label><input id="setName" placeholder="Techverse Solution"></div>
      <div class="form-group"><label>Address</label><textarea id="setAddress" rows="2"></textarea></div>
      <div class="form-group"><label>Contact</label><input id="setContact" placeholder="+91-..."></div>
      <div class="form-group"><label>GST %</label><input id="setGST" type="number" min="0" max="100" step="0.01" placeholder="18"></div>
      <div class="form-group"><label>Print Mode</label>
        <select id="setPrintMode"><option value="normal">Normal</option><option value="thermal">Thermal</option></select>
      </div>
      <div class="form-group"><label>Logo (upload)</label><input id="logoFile" type="file" accept="image/*"/></div>
      <div class="form-group"><label>Current Logo URL</label><input id="setLogoUrl" placeholder="(auto-filled after upload)"></div>
      <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
    </div>
  </div>

  <!-- Invoice Modal -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h3>Invoice</h3>
        <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
      </div>
      <div id="invoiceContent"></div>
      <div style="margin-top:20px;display:flex;gap:10px;">
        <button class="btn btn-primary" onclick="printInvoice()">Print Invoice</button>
        <button class="btn btn-secondary" onclick="closeInvoiceModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- Firebase (Compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

  <script>
  // ===== Firebase =====
  const firebaseConfig = {
    apiKey: "AIzaSyCBN5AMN7j_qnlnwulFHvIeR1NmLyQ0OZo",
    authDomain: "techverse-ca88a.firebaseapp.com",
    databaseURL: "https://techverse-ca88a-default-rtdb.firebaseio.com",
    projectId: "techverse-ca88a",
    storageBucket: "techverse-ca88a.firebasestorage.app",
    messagingSenderId: "288969741715",
    appId: "1:288969741715:web:03ddb8b82da9224e234466",
    measurementId: "G-33XTL4HJR9"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.firestore();
  const storage = firebase.storage();

  // ===== Helpers & State =====
  const $ = id => document.getElementById(id);
  const toastEl = $('toast');
  let UID = null;
  let settings = { name:'Techverse Solution', address:'', contact:'', gst:0, printMode:'normal', logoUrl:'' };
  let products = [];
  let customers = [];
  let transactions = [];
  let cart = [];
  let editingProductId = null;
  let editingCustomerId = null;

  function showToast(msg, type='success'){
    toastEl.textContent = msg;
    toastEl.className = 'toast ' + type;
    toastEl.style.display = 'block';
    setTimeout(()=> toastEl.style.display='none', 2500);
  }
  function currency(n){ return 'â‚¹' + (Number(n)||0).toFixed(2); }
  function switchTab(e, id){
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(b=>b.classList.remove('active'));
    $(id).classList.add('active');
    e.target.classList.add('active');
    if (id==='dashboard') loadDashboard();
    if (id==='products') renderProducts();
    if (id==='customers') renderCustomers();
    if (id==='pos') rebuildPOSSelectors();
    if (id==='reports') loadReports();
  }

  // ===== Auth (Login only) =====
$('loginBtn').addEventListener('click', async ()=>{
  const recaptchaResponse = grecaptcha.getResponse();
  if (!recaptchaResponse) {
    showToast('Please complete the reCAPTCHA check','error');
    return;
  }

    const email = $('loginEmail').value.trim();
    const pass = $('loginPassword').value.trim();
    try{
      await auth.signInWithEmailAndPassword(email, pass);
    }catch(err){ showToast(err.message || 'Login failed','error'); }
  });
  $('logoutBtn').addEventListener('click', ()=>auth.signOut());

  auth.onAuthStateChanged(async (u)=>{
    if(!u){
      UID = null;
      $('loginContainer').style.display='flex';
      $('appContainer').style.display='none';
      return;
    }
    UID = u.uid;
    $('userInfo').textContent = u.email;
    $('loginContainer').style.display='none';
    $('appContainer').style.display='block';

    // Ensure settings doc exists
    const setRef = db.collection('users').doc(UID).collection('meta').doc('settings');
    const snap = await setRef.get();
    if(!snap.exists){
      await setRef.set(settings);
    }else{
      settings = { ...settings, ...snap.data() };
    }
    // apply print mode to POS selector
    $('printModeSelect').value = settings.printMode || 'normal';
    applyPrintModeClass();

    // Live listeners
    db.collection('users').doc(UID).collection('meta').doc('settings')
      .onSnapshot(s=>{ if(s.exists){ settings = { ...settings, ...s.data() }; $('printModeSelect').value = settings.printMode||'normal'; }});

  // âœ… FIXED Product Listener (shows all unless deleted=true)
db.collection('users').doc(UID).collection('products')
  .onSnapshot(qs => {
    products = qs.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(p => !p.deleted); // show all if deleted is not true
    renderProducts();
    rebuildPOSSelectors();
  });
// âœ… Listen for all sales from root-level "sales" collection
db.collection('sales')
  .orderBy('createdAt', 'desc')
  .limit(200)
  .onSnapshot(qs => {
    transactions = qs.docs.map(d => ({ id: d.id, ...d.data() }));
    loadDashboard();
  });


    db.collection('users').doc(UID).collection('customers')
      .onSnapshot(qs=>{
        customers = qs.docs.map(d=>({id:d.id,...d.data()}));
        renderCustomers();
      });

    db.collection('users').doc(UID).collection('transactions')
      .orderBy('createdAt','desc').limit(200).onSnapshot(qs=>{
        transactions = qs.docs.map(d=>({id:d.id,...d.data()}));
        loadDashboard();
      });
  });

  // ===== Settings (Store Header) =====
  function openSettings(){
    $('setName').value = settings.name || 'Techverse Solution';
    $('setAddress').value = settings.address || '';
    $('setContact').value = settings.contact || '';
    $('setGST').value = settings.gst ?? 0;
    $('setPrintMode').value = settings.printMode || 'normal';
    $('setLogoUrl').value = settings.logoUrl || '';
    $('settingsModal').classList.add('active');
  }
  function closeSettings(){ $('settingsModal').classList.remove('active'); }

  async function saveSettings(){
    try{
      const name = $('setName').value.trim() || 'Techverse Solution';
      const address = $('setAddress').value.trim();
      const contact = $('setContact').value.trim();
      const gst = Number($('setGST').value || 0);
      const printMode = $('setPrintMode').value || 'normal';
      let logoUrl = $('setLogoUrl').value.trim() || settings.logoUrl || '';

      const file = $('logoFile').files[0];
      if(file){
        const ref = storage.ref().child(`users/${UID}/logo_${Date.now()}.${(file.name.split('.').pop()||'png')}`);
        await ref.put(file);
        logoUrl = await ref.getDownloadURL();
        $('setLogoUrl').value = logoUrl;
      }

      const payload = { name, address, contact, gst, printMode, logoUrl };
      await db.collection('users').doc(UID).collection('meta').doc('settings').set(payload,{merge:true});
      settings = { ...settings, ...payload };
      $('printModeSelect').value = settings.printMode;
      applyPrintModeClass();
      showToast('Settings saved');
      closeSettings();
    }catch(e){ showToast('Error saving settings: '+(e.message||e),'error'); }
  }

  function applyPrintModeSelect(){ settings.printMode = $('printModeSelect').value; applyPrintModeClass(); }
  function applyPrintModeClass(){
    document.body.classList.remove('print-thermal','print-normal');
    document.body.classList.add(settings.printMode==='thermal'?'print-thermal':'print-normal');
  }

  // ===== Products =====
  function showAddProductModal(){
    editingProductId = null;
    $('productModalTitle').textContent = 'Add Product';
    $('productName').value = '';
    $('productCategory').value = '';
    $('productQuantity').value = '';
    $('productCost').value = '';
    $('productSelling').value = '';
    $('productSupplier').value = '';
    $('productSKU').value = '';
    $('productModal').classList.add('active');
  }
  function closeProductModal(){ $('productModal').classList.remove('active'); }

  async function saveProduct(){
    const name = $('productName').value.trim();
    const category = $('productCategory').value.trim();
    const quantity = Number($('productQuantity').value || 0);
    const cost = Number($('productCost').value || 0);
    const selling = Number($('productSelling').value || 0);
    const supplier = $('productSupplier').value.trim();
    const sku = $('productSKU').value.trim();

    if(!name || !category || quantity<0 || cost<0 || selling<0){
      showToast('Please fill all required fields correctly!','error'); return;
    }
    const col = db.collection('users').doc(UID).collection('products');

    try{
      if(editingProductId){
        await col.doc(editingProductId).set({name,category,quantity,cost,selling,supplier,sku},{merge:true});
        showToast('Product updated!');
      }else{
        await col.add({name,category,quantity,cost,selling,supplier,sku,createdAt:firebase.firestore.FieldValue.serverTimestamp(),soldQuantity:0});
        showToast('Product added!');
      }
      closeProductModal();
    }catch(e){ showToast(e.message||'Error saving product','error'); }
  }

  function renderProducts(){
    $('totalProducts').textContent = products.length;
    const lowStock = products.filter(p=> (p.quantity??0) < 10);
    $('lowStockCount').textContent = lowStock.length;

    const rows = products.map(p=>`
      <tr>
        <td>${p.name}</td>
        <td>${p.category}</td>
        <td>${(p.quantity??0) < 10 ? '<span class="low-stock">'+(p.quantity??0)+'</span>' : (p.quantity??0)}</td>
        <td>â‚¹${Number(p.cost||0).toFixed(2)}</td>
        <td>â‚¹${Number(p.selling||0).toFixed(2)}</td>
        <td>${p.supplier||'-'}</td>
        <td>${p.sku||'-'}</td>
        <td class="actions">
          <button class="btn btn-sm btn-primary" onclick="editProduct('${p.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Delete</button>
        </td>
      </tr>`).join('');
    $('productsTable').innerHTML = rows || '<tr><td colspan="8" style="text-align:center;">No products found</td></tr>';

    // Low stock table on dashboard
    $('lowStockTable').innerHTML = lowStock.map(p=>`
      <tr><td>${p.name}</td><td>${p.category}</td><td><span class="low-stock">${p.quantity??0}</span></td><td>${p.sku||'-'}</td></tr>
    `).join('') || '<tr><td colspan="4" style="text-align:center;">All products well stocked</td></tr>';
  }

  function searchProducts(){
    const q = $('productSearch').value.toLowerCase();
    const filtered = products.filter(p =>
      (p.name||'').toLowerCase().includes(q) ||
      (p.category||'').toLowerCase().includes(q) ||
      (p.sku||'').toLowerCase().includes(q)
    );
    $('productsTable').innerHTML = filtered.map(p=>`
      <tr>
        <td>${p.name}</td><td>${p.category}</td>
        <td>${(p.quantity??0) < 10 ? '<span class="low-stock">'+(p.quantity??0)+'</span>' : (p.quantity??0)}</td>
        <td>â‚¹${Number(p.cost||0).toFixed(2)}</td><td>â‚¹${Number(p.selling||0).toFixed(2)}</td>
        <td>${p.supplier||'-'}</td><td>${p.sku||'-'}</td>
        <td class="actions">
          <button class="btn btn-sm btn-primary" onclick="editProduct('${p.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Delete</button>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="8" style="text-align:center;">No products</td></tr>';
  }

  function editProduct(id){
    const p = products.find(x=>x.id===id); if(!p) return;
    editingProductId = id;
    $('productModalTitle').textContent = 'Edit Product';
    $('productName').value = p.name||'';
    $('productCategory').value = p.category||'';
    $('productQuantity').value = p.quantity??0;
    $('productCost').value = p.cost??0;
    $('productSelling').value = p.selling??0;
    $('productSupplier').value = p.supplier||'';
    $('productSKU').value = p.sku||'';
    $('productModal').classList.add('active');
  }

  async function deleteProduct(id){
    if(!confirm('Delete this product?')) return;
    await db.collection('users').doc(UID).collection('products').doc(id).set({deleted:true},{merge:true});
    showToast('Product deleted');
  }

  // ===== Customers =====
  function showAddCustomerModal(){
    editingCustomerId = null;
    $('customerModalTitle').textContent = 'Add Customer';
    $('customerName').value = '';
    $('customerContact').value = '';
    $('customerAddress').value = '';
    $('customerModal').classList.add('active');
  }
  function closeCustomerModal(){ $('customerModal').classList.remove('active'); }

  async function saveCustomer(){
    const name = $('customerName').value.trim();
    const contact = $('customerContact').value.trim();
    const address = $('customerAddress').value.trim();
    if(!name || !contact){ showToast('Please fill required fields','error'); return; }
    const col = db.collection('users').doc(UID).collection('customers');
    try{
      if(editingCustomerId){
        await col.doc(editingCustomerId).set({name,contact,address},{merge:true});
        showToast('Customer updated');
      }else{
        await col.add({name,contact,address,totalPurchases:0,createdAt:firebase.firestore.FieldValue.serverTimestamp()});
        showToast('Customer added');
      }
      closeCustomerModal();
    }catch(e){ showToast(e.message||'Error saving customer','error'); }
  }

  function renderCustomers(){
    $('totalCustomers').textContent = customers.length;
    $('customersTable').innerHTML = customers.map(c=>`
      <tr>
        <td>${c.name}</td><td>${c.contact}</td><td>${c.address||'-'}</td>
        <td>â‚¹${Number(c.totalPurchases||0).toFixed(2)}</td>
        <td class="actions">
          <button class="btn btn-sm btn-primary" onclick="editCustomer('${c.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${c.id}')">Delete</button>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="5" style="text-align:center;">No customers</td></tr>';
  }

  function searchCustomers(){
    const q = $('customerSearch').value.toLowerCase();
    const filtered = customers.filter(c => (c.name||'').toLowerCase().includes(q) || (c.contact||'').toLowerCase().includes(q));
    $('customersTable').innerHTML = filtered.map(c=>`
      <tr>
        <td>${c.name}</td><td>${c.contact}</td><td>${c.address||'-'}</td>
        <td>â‚¹${Number(c.totalPurchases||0).toFixed(2)}</td>
        <td class="actions">
          <button class="btn btn-sm btn-primary" onclick="editCustomer('${c.id}')">Edit</button>
          <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${c.id}')">Delete</button>
        </td>
      </tr>
    `).join('') || '<tr><td colspan="5" style="text-align:center;">No customers</td></tr>';
  }

  function editCustomer(id){
    const c = customers.find(x=>x.id===id); if(!c) return;
    editingCustomerId = id;
    $('customerModalTitle').textContent = 'Edit Customer';
    $('customerName').value = c.name||'';
    $('customerContact').value = c.contact||'';
    $('customerAddress').value = c.address||'';
    $('customerModal').classList.add('active');
  }

  async function deleteCustomer(id){
    if(!confirm('Delete this customer?')) return;
    await db.collection('users').doc(UID).collection('customers').doc(id).delete();
    showToast('Customer deleted');
  }

  // ===== POS / Cart =====
  function rebuildPOSSelectors(){
    const opts = ['<option value="">-- Select Product --</option>']
      .concat(products.filter(p=> (p.quantity??0) > 0)
        .map(p=>`<option value="${p.id}">${p.name} - â‚¹${Number(p.selling||0).toFixed(2)} (Stock: ${p.quantity??0})</option>`));
    $('posProductSelect').innerHTML = opts.join('');
  }

  function addToCart(){
    const id = $('posProductSelect').value; if(!id) return;
    const p = products.find(x=>x.id===id); if(!p) return;
    const ex = cart.find(i=>i.id===id);
    if(ex){
      if(ex.quantity < (p.quantity??0)) ex.quantity++;
      else return showToast('Not enough stock','error');
    }else{
      cart.push({id:p.id,name:p.name,price:Number(p.selling||0),quantity:1,maxQuantity:(p.quantity??0)});
    }
    $('posProductSelect').value = '';
    updateCart();
  }
  function removeFromCart(i){ cart.splice(i,1); updateCart(); }
  function updateCartQuantity(i,delta){
    const it = cart[i]; if(!it) return;
    const q = it.quantity + delta;
    if(q<=0) removeFromCart(i);
    else if(q<=it.maxQuantity){ it.quantity=q; updateCart(); }
    else showToast('Not enough stock','error');
  }

  function updateCart(){
    $('cartItems').innerHTML = cart.map((it,i)=>`
      <tr>
        <td>${it.name}</td>
        <td>â‚¹${it.price.toFixed(2)}</td>
        <td><div class="quantity-control">
          <button onclick="updateCartQuantity(${i},-1)">-</button>
          <span>${it.quantity}</span>
          <button onclick="updateCartQuantity(${i},1)">+</button>
        </div></td>
        <td>â‚¹${(it.price*it.quantity).toFixed(2)}</td>
        <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${i})">Remove</button></td>
      </tr>
    `).join('') || '<tr><td colspan="5" style="text-align:center;">Cart is empty</td></tr>';

    const subtotal = cart.reduce((s,x)=>s + x.price*x.quantity, 0);
    const taxPercent = Number($('taxPercent').value||0);
    const taxAmount = subtotal * taxPercent / 100;
    const discount = Number($('discountAmount').value||0);
    const grand = subtotal + taxAmount - discount;

    $('subtotal').textContent = currency(subtotal);
    $('taxAmount').textContent = currency(taxAmount);
    $('discount').textContent = currency(discount);
    $('grandTotal').textContent = currency(grand);
  }

  function clearCart(){
    cart = [];
    $('taxPercent').value = settings.gst || 0;
    $('discountAmount').value = 0;
    $('billCustomerName').value = '';
    $('billCustomerPhone').value = '';
    updateCart();
  }

  async function completeSale(){
    if(cart.length===0) return showToast('Cart is empty','error');

    const customerName = $('billCustomerName').value.trim() || 'Walk-in';
    const customerPhone = $('billCustomerPhone').value.trim();

    // ensure settings.gst appears by default in POS tax field if empty
    const gstDefault = settings.gst || 0;
    const taxPercent = Number($('taxPercent').value || gstDefault || 0);
    const discount = Number($('discountAmount').value || 0);
    const paymentMode = $('paymentMode').value;

    const subtotal = cart.reduce((s,x)=>s + x.price*x.quantity, 0);
    const taxAmount = subtotal * taxPercent / 100;
    const total = subtotal + taxAmount - discount;

    // Save / upsert customer if phone present
    let customerId = null;
    if(customerPhone){
      const exists = customers.find(c=> (c.contact||'')===customerPhone);
      if(exists){ customerId = exists.id; }
      else{
        const doc = await db.collection('users').doc(UID).collection('customers').add({
          name: customerName, contact: customerPhone, address:'', totalPurchases:0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        customerId = doc.id;
      }
      // increment total purchases
      if(customerId){
        await db.collection('users').doc(UID).collection('customers').doc(customerId)
          .set({ totalPurchases: firebase.firestore.FieldValue.increment(total) },{merge:true});
      }
    }

    // Create transaction
    const items = cart.map(x=>({productId:x.id,name:x.name,price:x.price,quantity:x.quantity}));
    const txRef = await db.collection('users').doc(UID).collection('transactions').add({
      invoiceNumber: 'INV-' + Date.now(),
      date: new Date().toISOString(),
      customerId: customerId || null,
      customerName, customerPhone,
      items, subtotal, taxPercent, taxAmount, discount, total, paymentMode,
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    });

    // Reduce stock
    for(const it of cart){
      const pref = db.collection('users').doc(UID).collection('products').doc(it.id);
      await pref.update({
        quantity: firebase.firestore.FieldValue.increment(-it.quantity),
        soldQuantity: firebase.firestore.FieldValue.increment(it.quantity)
      });
    }

    // Show invoice
    viewInvoice((await txRef.get()).data().invoiceNumber, true);
    clearCart();
    showToast('Sale completed');
  }

  // ===== Dashboard / Reports =====
function loadDashboard() {
  // ðŸ§® Total Sales (in â‚¹)
  const totalSales = transactions.reduce((sum, t) => sum + (t.total || 0), 0);
  $('totalSales').textContent = totalSales.toFixed(2);

  // ðŸ•“ Recent Transactions (last 5)
  const recents = [...transactions].slice(0, 5);
  $('recentTransactions').innerHTML =
    recents.map(t => `
      <tr>
        <td>${t.invoiceNumber || t.id}</td>
        <td>${
          t.createdAt && t.createdAt.toDate
            ? new Date(t.createdAt.toDate()).toLocaleDateString()
            : (t.date ? new Date(t.date).toLocaleDateString() : '-')
        }</td>
        <td>${t.customerName || 'Walk-in'}</td>
        <td>â‚¹${Number(t.total || 0).toFixed(2)}</td>
        <td><button class="btn btn-sm btn-primary" onclick="viewInvoice('${t.invoiceNumber || t.id}')">View</button></td>
      </tr>
    `).join('') ||
    '<tr><td colspan="5" style="text-align:center;">No transactions</td></tr>';
}


  // (Keeping your simple SVG chart util)
  function drawSalesChart(data){
    const chartContainer = $('salesChart');
    const width = chartContainer.parentElement.clientWidth || 800;
    const height = 300;
    const padding = { top: 40, right: 40, bottom: 60, left: 60 };
    const chartWidth = width - padding.left - padding.right;
    const chartHeight = height - padding.top - padding.bottom;
    const maxValue = Math.max(...data.map(d => d.sales), 1);
    const step = chartWidth / (data.length - 1 || 1);
    let svg = `<svg width="100%" height="${height}" style="font-family: inherit;">`;
    svg += `<rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#f9fafb" rx="4"/>`;
    for (let i = 0; i <= 4; i++) {
      const y = padding.top + (chartHeight * i / 4);
      const value = (maxValue * (4 - i) / 4).toFixed(0);
      svg += `<line x1="${padding.left}" y1="${y}" x2="${padding.left + chartWidth}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
      svg += `<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" font-size="11" fill="#6b7280">â‚¹${value}</text>`;
    }
    let pathData = ''; let areaPath = '';
    data.forEach((d,i)=>{
      const x = padding.left + (i * step);
      const y = padding.top + chartHeight - ((d.sales / maxValue) * chartHeight);
      if(i===0){ pathData = `M ${x} ${y}`; areaPath = `M ${x} ${padding.top + chartHeight} L ${x} ${y}`; }
      else{ pathData += ` L ${x} ${y}`; areaPath += ` L ${x} ${y}`; }
      svg += `<circle cx="${x}" cy="${y}" r="4" fill="#2563eb"/>`;
      svg += `<text x="${x}" y="${padding.top + chartHeight + 20}" text-anchor="middle" font-size="12" fill="#374151">${d.month}</text>`;
    });
    areaPath += ` L ${padding.left + ((data.length - 1) * step)} ${padding.top + chartHeight} Z`;
    svg += `<path d="${areaPath}" fill="rgba(37, 99, 235, 0.1)" stroke="none"/>`;
    svg += `<path d="${pathData}" fill="none" stroke="#2563eb" stroke-width="3"/>`;
    svg += `<text x="${width/2}" y="25" text-anchor="middle" font-size="14" font-weight="600" fill="#2563eb">Sales (â‚¹) - Last 6 Months</text>`;
    svg += `</svg>`;
    chartContainer.innerHTML = svg;
  }

  function loadReports(){
    const now = new Date(); const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
    const monthTx = transactions.filter(t=>{const d=new Date(t.date); return d.getMonth()===currentMonth && d.getFullYear()===currentYear;});
    const monthRevenue = monthTx.reduce((s,t)=>s+(t.total||0),0);
    $('monthRevenue').textContent = monthRevenue.toFixed(2);
    $('monthTransactions').textContent = monthTx.length;
    $('avgSale').textContent = monthTx.length>0 ? (monthRevenue/monthTx.length).toFixed(2) : '0';

    const last6 = [];
    for(let i=5;i>=0;i--){
      const d = new Date(currentYear, currentMonth - i, 1);
      const label = d.toLocaleString('default',{month:'short'});
      const msum = transactions.filter(t=>{const td=new Date(t.date);return td.getMonth()===d.getMonth()&&td.getFullYear()===d.getFullYear();})
                      .reduce((s,t)=>s+(t.total||0),0);
      last6.push({month:label,sales:msum});
    }
    drawSalesChart(last6);

    const best = [...products].filter(p=> (p.soldQuantity||0)>0).sort((a,b)=> (b.soldQuantity||0)-(a.soldQuantity||0)).slice(0,10);
    $('bestSellersTable').innerHTML = best.map(p=>`
      <tr><td>${p.name}</td><td>${p.category||'-'}</td><td>${p.soldQuantity||0}</td><td>â‚¹${Number((p.soldQuantity||0)* (p.selling||0)).toFixed(2)}</td></tr>
    `).join('') || '<tr><td colspan="4" style="text-align:center;">No sales data</td></tr>';
  }

  // ===== Invoice =====
  async function viewInvoice(invoiceNumber, openImmediately=false){
    const qs = await db.collection('users').doc(UID).collection('transactions').where('invoiceNumber','==',invoiceNumber).limit(1).get();
    if(qs.empty){ return showToast('Invoice not found','error'); }
    const t = qs.docs[0].data();

    const s = settings; // store header
    const itemsHtml = (t.items||[]).map(it=>`
      <tr>
        <td>${it.name}</td>
        <td>${it.quantity}</td>
        <td>â‚¹${Number(it.price||0).toFixed(2)}</td>
        <td>â‚¹${Number(it.price*it.quantity).toFixed(2)}</td>
      </tr>
    `).join('');

    const headerLogo = s.logoUrl ? `<img src="${s.logoUrl}" alt="logo" style="max-height:60px;display:block;margin:0 auto 8px;"/>` : '';
    const gstLine = Number(s.gst||0) > 0 ? `<div><strong>GST (${s.gst}%):</strong> â‚¹${Number(t.taxAmount||0).toFixed(2)}</div>` : '';

    const html = `
      <div class="invoice">
        <div class="invoice-header">
          ${headerLogo}
          <h1>${s.name || 'Techverse Solution'}</h1>
          ${s.address ? `<div style="color:#555">${s.address}</div>`:''}
          ${s.contact ? `<div style="color:#555">${s.contact}</div>`:''}
        </div>
        <div class="invoice-details">
          <div>
            <strong>Invoice #:</strong> ${t.invoiceNumber}<br>
            <strong>Date:</strong> ${new Date(t.date).toLocaleString()}<br>
            <strong>Payment:</strong> ${t.paymentMode || '-'}
          </div>
          <div style="text-align:right;">
            <strong>Customer:</strong> ${t.customerName || 'Walk-in'}<br>
            ${t.customerPhone ? `<strong>Phone:</strong> ${t.customerPhone}<br>`:''}
            <strong>Total Amount</strong><br>
            <span style="font-size:24px;color:#2563eb;">â‚¹${Number(t.total||0).toFixed(2)}</span>
          </div>
        </div>
        <table style="width:100%;border-collapse:collapse;">
          <thead><tr><th style="text-align:left;padding:8px;background:#f3f4f6;">Product</th><th style="text-align:left;padding:8px;background:#f3f4f6;">Quantity</th><th style="text-align:left;padding:8px;background:#f3f4f6;">Price (â‚¹)</th><th style="text-align:left;padding:8px;background:#f3f4f6;">Subtotal (â‚¹)</th></tr></thead>
          <tbody>${itemsHtml}</tbody>
        </table>
        <div style="margin-top:20px;text-align:right;">
          <div style="margin-bottom:8px;"><strong>Subtotal:</strong> â‚¹${Number(t.subtotal||0).toFixed(2)}</div>
          ${gstLine}
          <div style="margin-bottom:8px;"><strong>Discount:</strong> â‚¹${Number(t.discount||0).toFixed(2)}</div>
          <div style="font-size:20px;color:#2563eb;"><strong>Grand Total:</strong> â‚¹${Number(t.total||0).toFixed(2)}</div>
        </div>
        <div style="margin-top:30px;text-align:center;color:#666;font-size:12px;">Thank you for your business!</div>
      </div>
    `;
    $('invoiceContent').innerHTML = html;
    $('invoiceModal').classList.add('active');

    // apply print class
    document.body.classList.remove('print-thermal','print-normal');
    document.body.classList.add((settings.printMode||'normal')==='thermal' ? 'print-thermal' : 'print-normal');

    if(openImmediately===true){ /* already opened */ }
  }

  function closeInvoiceModal(){ $('invoiceModal').classList.remove('active'); }
  function printInvoice(){ window.print(); }

  // ===== Export / Import (JSON only for Firestore schema) =====
  async function exportData(type, fmt){
    try{
      const base = db.collection('users').doc(UID);
      let data, filename = `techverse_${type}`;
      if(type==='all'){
        const prods = await base.collection('products').get();
        const custs = await base.collection('customers').get();
        const txs = await base.collection('transactions').get();
        data = {
          settings, products: prods.docs.map(d=>({id:d.id,...d.data()})),
          customers: custs.docs.map(d=>({id:d.id,...d.data()})),
          transactions: txs.docs.map(d=>({id:d.id,...d.data()})),
        };
        filename = 'techverse_all_data';
      }else{
        const coll = await base.collection(type).get();
        data = coll.docs.map(d=>({id:d.id,...d.data()}));
      }

      const blob = new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `${filename}.json`; document.body.appendChild(a); a.click();
      a.remove(); URL.revokeObjectURL(url);
      showToast('Data exported');
    }catch(e){ showToast('Export error: '+(e.message||e),'error'); }
  }

  async function importData(){
    const type = $('importType').value;
    const file = $('importFile').files[0];
    if(!file) return showToast('Choose a JSON file','error');
    try{
      const text = await file.text();
      const json = JSON.parse(text);
      const base = db.collection('users').doc(UID);

      if(type==='all'){
        if(json.settings) await base.collection('meta').doc('settings').set(json.settings,{merge:true});
        if(Array.isArray(json.products)){
          for(const p of json.products){
            const id = p.id || undefined;
            const {id:_, ...rest} = p;
            if(id) await base.collection('products').doc(id).set(rest,{merge:true});
            else await base.collection('products').add(rest);
          }
        }
        if(Array.isArray(json.customers)){
          for(const c of json.customers){
            const id = c.id || undefined;
            const {id:_, ...rest} = c;
            if(id) await base.collection('customers').doc(id).set(rest,{merge:true});
            else await base.collection('customers').add(rest);
          }
        }
        if(Array.isArray(json.transactions)){
          for(const t of json.transactions){
            const id = t.id || undefined;
            const {id:_, ...rest} = t;
            if(id) await base.collection('transactions').doc(id).set(rest,{merge:true});
            else await base.collection('transactions').add(rest);
          }
        }
      }else{
        if(!Array.isArray(json)) return showToast('Invalid JSON format for this import type','error');
        for(const row of json){
          const id = row.id || undefined;
          const {id:_, ...rest} = row;
          if(id) await base.collection(type).doc(id).set(rest,{merge:true});
          else await base.collection(type).add(rest);
        }
      }
      showToast('Import complete');
      $('importFile').value = '';
    }catch(e){ showToast('Import error: '+(e.message||e),'error'); }
  }


  // ===== init defaults =====
  // Pre-fill POS tax with settings GST when available (after login it will update)
  document.addEventListener('DOMContentLoaded', ()=>{
    $('taxPercent').value = settings.gst || 0;
  });
  </script>  
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

</body>
</html>
