<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Techverse Solution – Inventory & Billing</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box}
    body{font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh}
    .login-container{display:flex;justify-content:center;align-items:center;min-height:100vh;padding:20px}
    .login-box{background:white;padding:40px;border-radius:15px;box-shadow:0 10px 40px rgba(0,0,0,0.2);max-width:400px;width:100%}
    .login-box h1{color:#2563eb;margin-bottom:10px;font-size:28px}
    .login-box p{color:#666;margin-bottom:30px}
    .form-group{margin-bottom:20px}
    .form-group label{display:block;margin-bottom:8px;color:#333;font-weight:500}
    .form-group input,.form-group select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px;transition:border-color .3s}
    .form-group input:focus,.form-group select:focus{outline:none;border-color:#2563eb}
    .btn{padding:12px 24px;border:none;border-radius:8px;cursor:pointer;font-size:14px;font-weight:600;transition:all .3s}
    .btn-primary{background:#2563eb;color:#fff}
    .btn-primary:hover{background:#1d4ed8;transform:translateY(-2px);box-shadow:0 5px 15px rgba(37,99,235,.3)}
    .btn-secondary{background:#6b7280;color:#fff}
    .btn-secondary:hover{background:#4b5563}
    .btn-success{background:#10b981;color:#fff}
    .btn-success:hover{background:#059669}
    .btn-danger{background:#ef4444;color:#fff}
    .btn-danger:hover{background:#dc2626}
    .btn-sm{padding:6px 12px;font-size:12px}
    .app-container{display:none;background:#f3f4f6;min-height:100vh}
    .header{background:#fff;padding:20px 30px;box-shadow:0 2px 10px rgba(0,0,0,.1);display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .header h1{color:#2563eb;font-size:24px}
    .header-right{display:flex;align-items:center;gap:15px}
    .user-info{color:#666;font-size:14px}
    .nav-tabs{background:#fff;padding:0 30px;display:flex;gap:5px;overflow-x:auto;box-shadow:0 2px 5px rgba(0,0,0,.05)}
    .nav-tab{padding:15px 20px;cursor:pointer;border:none;background:transparent;color:#666;font-weight:500;border-bottom:3px solid transparent;transition:all .3s;white-space:nowrap}
    .nav-tab:hover{color:#2563eb;background:#eff6ff}
    .nav-tab.active{color:#2563eb;border-bottom-color:#2563eb}
    .content{padding:30px;max-width:1400px;margin:0 auto}
    .tab-content{display:none}
    .tab-content.active{display:block}
    .card{background:#fff;border-radius:12px;padding:25px;box-shadow:0 2px 10px rgba(0,0,0,.08);margin-bottom:20px}
    .card h2{color:#1f2937;margin-bottom:20px;font-size:20px}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}
    .stat-card{background:linear-gradient(135deg,#2563eb 0%,#1d4ed8 100%);color:#fff;padding:25px;border-radius:12px;box-shadow:0 4px 15px rgba(37,99,235,.3)}
    .stat-card.green{background:linear-gradient(135deg,#10b981 0%,#059669 100%);box-shadow:0 4px 15px rgba(16,185,129,.3)}
    .stat-card.orange{background:linear-gradient(135deg,#f59e0b 0%,#d97706 100%);box-shadow:0 4px 15px rgba(245,158,11,.3)}
    .stat-card.purple{background:linear-gradient(135deg,#8b5cf6 0%,#7c3aed 100%);box-shadow:0 4px 15px rgba(139,92,246,.3)}
    .stat-label{font-size:14px;opacity:.9;margin-bottom:8px}
    .stat-value{font-size:32px;font-weight:bold}
    .form-row{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}
    .search-box{margin-bottom:20px}
    .search-box input{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    thead{background:#f3f4f6}
    th{padding:12px;text-align:left;color:#374151;font-weight:600;font-size:13px}
    td{padding:12px;border-bottom:1px solid #e5e7eb;color:#4b5563;font-size:14px}
    tr:hover{background:#f9fafb}
    .actions{display:flex;gap:8px}
    .toast{position:fixed;top:20px;right:20px;background:#fff;padding:15px 20px;border-radius:8px;box-shadow:0 5px 20px rgba(0,0,0,.2);display:none;z-index:1000;animation:slideIn .3s ease}
    @keyframes slideIn{from{transform:translateX(400px);opacity:0}to{transform:translateX(0);opacity:1}}
    .toast.success{border-left:4px solid #10b981}
    .toast.error{border-left:4px solid #ef4444}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.5);z-index:999;justify-content:center;align-items:center;padding:20px}
    .modal.active{display:flex}
    .modal-content{background:#fff;padding:30px;border-radius:12px;max-width:600px;width:100%;max-height:90vh;overflow-y:auto}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px}
    .modal-header h3{color:#1f2937;font-size:20px}
    .close-btn{background:none;border:none;font-size:24px;cursor:pointer;color:#9ca3af}
    .close-btn:hover{color:#374151}
    .pos-grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
    .product-select{margin-bottom:15px}
    .product-select select{width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-size:14px}
    .low-stock{background:#fef3c7;color:#92400e;padding:2px 8px;border-radius:4px;font-size:11px;font-weight:600}
    .quantity-control{display:flex;align-items:center;gap:8px}
    .quantity-control button{width:28px;height:28px;border:none;background:#2563eb;color:#fff;border-radius:4px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center}
    .quantity-control span{min-width:30px;text-align:center}
    .invoice{max-width:800px;margin:0 auto;padding:40px;background:#fff}
    .invoice-header{text-align:center;border-bottom:2px solid #2563eb;padding-bottom:20px;margin-bottom:30px}
    .invoice-header h1{color:#2563eb;font-size:28px;margin-bottom:5px}
    .invoice-details{display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:30px}
    @media print{body *{visibility:hidden} .print-root,.print-root *{visibility:visible} .print-root{position:absolute;left:0;top:0;width:100%} .btn{display:none}}
    @media (max-width:768px){.pos-grid{grid-template-columns:1fr}.header h1{font-size:18px}.content{padding:15px}.nav-tabs{padding:0 15px}.form-row{grid-template-columns:1fr}table{font-size:12px}th,td{padding:8px 4px}}
    /* Print modes */
    .thermal .bill{width:58mm;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,"Liberation Mono","Courier New",monospace}
    .thermal .bill *{line-height:1.2}
    .normal .bill{width:100%;max-width:700px}
  </style>

  <!-- Firebase compat SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
</head>
<body>
  <div id="toast" class="toast"></div>

  <!-- LOGIN -->
  <div id="loginContainer" class="login-container">
    <div class="login-box">
      <h1>Techverse Solution</h1>
      <p>Inventory & Billing System (Firebase)</p>
      <div class="form-group">
        <label>Email</label>
        <input type="email" id="loginEmail" placeholder="you@company.com">
      </div>
      <div class="form-group">
        <label>Password</label>
        <input type="password" id="loginPassword" placeholder="••••••••">
      </div>
      <button class="btn btn-primary" id="loginBtn">Login</button>
      <p style="color:#888;margin-top:10px;font-size:12px">No account creation here — use Firebase Auth.</p>
    </div>
  </div>

  <!-- APP -->
  <div id="appContainer" class="app-container">
    <div class="header">
      <h1>Techverse Solution – Inventory & Billing</h1>
      <div class="header-right">
        <span class="user-info" id="userInfo"></span>
        <button class="btn btn-secondary btn-sm" id="logoutBtn">Logout</button>
      </div>
    </div>

    <div class="nav-tabs">
      <button class="nav-tab active" onclick="switchTab(event,'dashboard')">Dashboard</button>
      <button class="nav-tab" onclick="switchTab(event,'products')">Products</button>
      <button class="nav-tab" onclick="switchTab(event,'pos')">POS</button>
      <button class="nav-tab" onclick="switchTab(event,'customers')">Customers</button>
      <button class="nav-tab" onclick="switchTab(event,'reports')">Reports</button>
      <button class="nav-tab" onclick="switchTab(event,'export')">Export</button>
      <button class="nav-tab" onclick="switchTab(event,'import')">Import</button>
      <button class="nav-tab" onclick="switchTab(event,'settings')">Settings</button>
    </div>

    <div class="content">
      <!-- DASHBOARD -->
      <div id="dashboard" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card">
            <div class="stat-label">Total Products</div>
            <div class="stat-value" id="totalProducts">0</div>
          </div>
          <div class="stat-card green">
            <div class="stat-label">Total Customers</div>
            <div class="stat-value" id="totalCustomers">0</div>
          </div>
          <div class="stat-card orange">
            <div class="stat-label">Total Sales (₹)</div>
            <div class="stat-value" id="totalSales">0</div>
          </div>
          <div class="stat-card purple">
            <div class="stat-label">Low Stock Items</div>
            <div class="stat-value" id="lowStockCount">0</div>
          </div>
        </div>

        <div class="card">
          <h2>Recent Transactions</h2>
          <table id="recentTransactionsTable">
            <thead>
              <tr>
                <th>Invoice #</th>
                <th>Date</th>
                <th>Customer</th>
                <th>Total (₹)</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="recentTransactions"></tbody>
          </table>
        </div>

        <div class="card">
          <h2>Low Stock Alerts</h2>
          <table>
            <thead>
              <tr>
                <th>Product</th>
                <th>Category</th>
                <th>Current Stock</th>
                <th>SKU</th>
              </tr>
            </thead>
            <tbody id="lowStockTable"></tbody>
          </table>
        </div>
      </div>

      <!-- PRODUCTS -->
      <div id="products" class="tab-content">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="margin:0;">Product Management</h2>
            <button class="btn btn-primary" onclick="showAddProductModal()">Add Product</button>
          </div>
          <div class="search-box">
            <input type="text" id="productSearch" placeholder="Search products..." onkeyup="searchProducts()">
          </div>
          <table>
            <thead>
            <tr>
              <th>Name</th><th>Category</th><th>Quantity</th><th>Cost (₹)</th><th>Selling (₹)</th><th>Supplier</th><th>SKU</th><th>Actions</th>
            </tr>
            </thead>
            <tbody id="productsTable"></tbody>
          </table>
        </div>
      </div>

      <!-- POS -->
      <div id="pos" class="tab-content">
        <div class="pos-grid">
          <div class="card">
            <h2>Select Products</h2>
            <div class="product-select">
              <select id="posProductSelect" onchange="addToCart()">
                <option value="">-- Select Product --</option>
              </select>
            </div>
            <table>
              <thead>
              <tr><th>Product</th><th>Price (₹)</th><th>Qty</th><th>Subtotal (₹)</th><th>Actions</th></tr>
              </thead>
              <tbody id="cartItems"></tbody>
            </table>
          </div>

          <div class="card">
            <h2>Billing Details</h2>

            <div class="form-group">
              <label>Customer Name</label>
              <input type="text" id="custName" placeholder="e.g., Ahmed Khan">
            </div>
            <div class="form-group">
              <label>Customer Phone</label>
              <input type="text" id="custPhone" placeholder="+91 9xxxxxxxxx">
            </div>

            <div class="form-group">
              <label>Tax (%)</label>
              <input type="number" id="taxPercent" value="0" min="0" max="100" onchange="updateCart()">
            </div>
            <div class="form-group">
              <label>Discount (₹)</label>
              <input type="number" id="discountAmount" value="0" min="0" onchange="updateCart()">
            </div>
            <div class="form-group">
              <label>Payment Mode</label>
              <select id="paymentMode">
                <option value="cash">Cash</option>
                <option value="online">Online</option>
              </select>
            </div>

            <div class="cart-total">
              <div class="total-row"><span>Subtotal:</span><span id="subtotal">₹0</span></div>
              <div class="total-row"><span>Tax:</span><span id="taxAmount">₹0</span></div>
              <div class="total-row"><span>Discount:</span><span id="discount">₹0</span></div>
              <div class="total-row grand"><span>Grand Total:</span><span id="grandTotal">₹0</span></div>
            </div>

            <button class="btn btn-success" style="width:100%;margin-top:20px" onclick="completeSale()">Complete Sale</button>
            <button class="btn btn-secondary" style="width:100%;margin-top:10px" onclick="clearCart()">Clear Cart</button>
          </div>
        </div>
      </div>

      <!-- CUSTOMERS -->
      <div id="customers" class="tab-content">
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;">
            <h2 style="margin:0;">Customer Management</h2>
            <button class="btn btn-primary" onclick="showAddCustomerModal()">Add Customer</button>
          </div>
          <div class="search-box">
            <input type="text" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
          </div>
          <table>
            <thead>
            <tr><th>Name</th><th>Contact</th><th>Address</th><th>Total Purchases (₹)</th><th>Actions</th></tr>
            </thead>
            <tbody id="customersTable"></tbody>
          </table>
        </div>
      </div>

      <!-- REPORTS -->
      <div id="reports" class="tab-content">
        <div class="card">
          <h2>Sales Report</h2>
          <div class="chart-container">
            <div id="salesChart"></div>
          </div>
        </div>

        <div class="card">
          <h2>Best Selling Products</h2>
          <table>
            <thead>
            <tr><th>Product</th><th>Category</th><th>Units Sold</th><th>Revenue (₹)</th></tr>
            </thead>
            <tbody id="bestSellersTable"></tbody>
          </table>
        </div>

        <div class="card">
          <h2>Monthly Summary</h2>
          <div class="stats-grid">
            <div class="stat-card green">
              <div class="stat-label">This Month Revenue (₹)</div>
              <div class="stat-value" id="monthRevenue">0</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">This Month Transactions</div>
              <div class="stat-value" id="monthTransactions">0</div>
            </div>
            <div class="stat-card purple">
              <div class="stat-label">Average Sale (₹)</div>
              <div class="stat-value" id="avgSale">0</div>
            </div>
          </div>
        </div>
      </div>

      <!-- EXPORT -->
      <div id="export" class="tab-content">
        <div class="card">
          <h2>Export Data</h2>
          <p style="color:#666;margin-bottom:20px">Download your data from Firestore.</p>
          <div style="display:flex;gap:15px;flex-wrap:wrap;">
            <button class="btn btn-primary" onclick="exportData('products')">Export Products (JSON)</button>
            <button class="btn btn-success" onclick="exportData('customers')">Export Customers (JSON)</button>
            <button class="btn btn-secondary" onclick="exportData('transactions')">Export Transactions (JSON)</button>
            <button class="btn btn-danger" onclick="exportAll()">Export All (JSON)</button>
          </div>
        </div>
      </div>

      <!-- IMPORT -->
      <div id="import" class="tab-content">
        <div class="card">
          <h2>Import Data</h2>
          <p style="color:#666;margin-bottom:20px;">Import JSON exported from this app.</p>
          <div class="form-group">
            <label>Select Data Type</label>
            <select id="importType">
              <option value="products">Products</option>
              <option value="customers">Customers</option>
              <option value="transactions">Transactions</option>
            </select>
          </div>
          <div class="form-group">
            <label>Select File (JSON)</label>
            <input type="file" id="importFile" accept=".json">
          </div>
          <button class="btn btn-primary" onclick="importData()">Import Data</button>
        </div>
      </div>

      <!-- SETTINGS -->
      <div id="settings" class="tab-content">
        <div class="card">
          <h2>Company Settings</h2>
          <div class="form-row">
            <div class="form-group">
              <label>Store Name</label>
              <input id="setName" placeholder="Techverse Solution">
            </div>
            <div class="form-group">
              <label>Contact</label>
              <input id="setContact" placeholder="+91 9xxxxxxxxx">
            </div>
          </div>
          <div class="form-group">
            <label>Address</label>
            <input id="setAddress" placeholder="Full billing address">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Tax % (Default GST %)</label>
              <input id="setGSTPercent" type="number" min="0" step="0.01" placeholder="e.g., 18">
            </div>
            <div class="form-group">
              <label>GST Number</label>
              <input id="setGST" placeholder="e.g., 22AAAAA0000A1Z5">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Print Mode</label>
              <select id="setPrintMode">
                <option value="thermal">Thermal</option>
                <option value="normal">Normal</option>
              </select>
            </div>
            <div class="form-group">
              <label>Logo (upload from device)</label>
              <input id="setLogoFile" type="file" accept="image/*">
              <div style="margin-top:10px">
                <img id="logoPreview" src="" alt="" style="max-height:60px;display:none;border:1px solid #eee;border-radius:6px;padding:4px;background:#fff">
              </div>
            </div>
          </div>
          <div style="display:flex;gap:10px;margin-top:10px">
            <button class="btn btn-success" onclick="saveSettings()">Save Settings</button>
            <button class="btn btn-secondary" onclick="reloadSettings()">Reload</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- PRODUCT MODAL -->
  <div id="productModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="productModalTitle">Add Product</h3>
        <button class="close-btn" onclick="closeProductModal()">&times;</button>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Product Name *</label>
          <input type="text" id="productName">
        </div>
        <div class="form-group">
          <label>Category *</label>
          <input type="text" id="productCategory">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Quantity *</label>
          <input type="number" id="productQuantity" min="0" value="0">
        </div>
        <div class="form-group">
          <label>Cost Price (₹) *</label>
          <input type="number" id="productCost" min="0" step="0.01" value="0">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Selling Price (₹) *</label>
          <input type="number" id="productSelling" min="0" step="0.01" value="0">
        </div>
        <div class="form-group">
          <label>Supplier</label>
          <input type="text" id="productSupplier">
        </div>
      </div>
      <div class="form-group">
        <label>SKU/Barcode</label>
        <input type="text" id="productSKU">
      </div>
      <button class="btn btn-primary" onclick="saveProduct()">Save Product</button>
    </div>
  </div>

  <!-- CUSTOMER MODAL -->
  <div id="customerModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="customerModalTitle">Add Customer</h3>
        <button class="close-btn" onclick="closeCustomerModal()">&times;</button>
      </div>
      <div class="form-group">
        <label>Customer Name *</label>
        <input type="text" id="customerName">
      </div>
      <div class="form-group">
        <label>Contact Number *</label>
        <input type="text" id="customerContact">
      </div>
      <div class="form-group">
        <label>Address</label>
        <textarea id="customerAddress" rows="3" style="width:100%;padding:12px;border:2px solid #e5e7eb;border-radius:8px;font-family:inherit;"></textarea>
      </div>
      <button class="btn btn-primary" onclick="saveCustomer()">Save Customer</button>
    </div>
  </div>

  <!-- INVOICE MODAL -->
  <div id="invoiceModal" class="modal">
    <div class="modal-content" style="max-width:900px;">
      <div class="modal-header">
        <h3>Invoice</h3>
        <button class="close-btn" onclick="closeInvoiceModal()">&times;</button>
      </div>
      <div id="invoiceContent"></div>
      <div style="margin-top:20px;display:flex;gap:10px;">
        <button class="btn btn-primary" onclick="printInvoice()">Print Invoice</button>
        <button class="btn btn-secondary" onclick="closeInvoiceModal()">Close</button>
      </div>
    </div>
  </div>

  <!-- PRINT ROOT -->
  <div id="printRoot" class="print-root normal" style="display:none;padding:16px;">
    <div id="printBill" class="bill mx-auto bg-white p-4 rounded shadow"></div>
  </div>

<script>
/* ------------------ Firebase ------------------ */
const firebaseConfig = {
  apiKey: "AIzaSyCBN5AMN7j_qnlnwulFHvIeR1NmLyQ0OZo",
  authDomain: "techverse-ca88a.firebaseapp.com",
  databaseURL: "https://techverse-ca88a-default-rtdb.firebaseio.com",
  projectId: "techverse-ca88a",
  storageBucket: "techverse-ca88a.firebasestorage.app",
  messagingSenderId: "288969741715",
  appId: "1:288969741715:web:03ddb8b82da9224e234466",
  measurementId: "G-33XTL4HJR9"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();
const storage = firebase.storage();

/* ------------------ Helpers & State ------------------ */
const $ = (id) => document.getElementById(id);
const show = (el,cond) => el.style.display = cond ? '' : 'none';
function toast(msg,type='success'){ const t=$('toast'); t.textContent=msg; t.className='toast '+type; t.style.display='block'; setTimeout(()=>t.style.display='none',3000); }
function currency(n){ return '₹'+(Number(n)||0).toFixed(2); }
function svgChart(containerId, data) {
  const chartContainer = $(containerId);
  const width = chartContainer.parentElement.clientWidth || 800;
  const height = 300;
  const padding = { top: 40, right: 40, bottom: 60, left: 60 };
  const chartWidth = width - padding.left - padding.right;
  const chartHeight = height - padding.top - padding.bottom;

  const maxValue = Math.max(...data.map(d => d.sales), 1);
  const step = chartWidth / (Math.max(data.length - 1, 1));
  let svg = `<svg width="100%" height="${height}" style="font-family: inherit;">`;
  svg += `<rect x="${padding.left}" y="${padding.top}" width="${chartWidth}" height="${chartHeight}" fill="#f9fafb" rx="4"/>`;
  for (let i=0;i<=4;i++) {
    const y = padding.top + (chartHeight * i / 4);
    const value = (maxValue * (4 - i) / 4).toFixed(0);
    svg += `<line x1="${padding.left}" y1="${y}" x2="${padding.left + chartWidth}" y2="${y}" stroke="#e5e7eb" stroke-width="1"/>`;
    svg += `<text x="${padding.left - 10}" y="${y + 4}" text-anchor="end" font-size="11" fill="#6b7280">₹${value}</text>`;
  }
  let pathData = '', areaPath = '';
  data.forEach((d,i)=>{
    const x = padding.left + (i*step);
    const y = padding.top + chartHeight - ((d.sales / maxValue) * chartHeight);
    if (i===0) { pathData = `M ${x} ${y}`; areaPath = `M ${x} ${padding.top+chartHeight} L ${x} ${y}`; }
    else { pathData += ` L ${x} ${y}`; areaPath += ` L ${x} ${y}`; }
    svg += `<circle cx="${x}" cy="${y}" r="4" fill="#2563eb"/>`;
    svg += `<text x="${x}" y="${padding.top+chartHeight+20}" text-anchor="middle" font-size="12" fill="#374151">${d.month}</text>`;
  });
  areaPath += ` L ${padding.left + ((Math.max(data.length - 1, 0))*step)} ${padding.top+chartHeight} Z`;
  svg += `<path d="${areaPath}" fill="rgba(37,99,235,.1)" stroke="none"/>`;
  svg += `<path d="${pathData}" fill="none" stroke="#2563eb" stroke-width="3"/>`;
  svg += `<text x="${width/2}" y="25" text-anchor="middle" font-size="14" font-weight="600" fill="#2563eb">Sales (₹) - Last 6 Months</text>`;
  svg += `</svg>`;
  chartContainer.innerHTML = svg;
}

/* ------------------ App State ------------------ */
let currentUser = null;
let settings = { name: 'Techverse Solution', address: '', contact: '', gst: '', gstPercent: 0, printMode: 'normal', logo: '' };
let products = [];
let customers = [];
let transactions = [];
let cart = [];
let editingProductId = null;
let editingCustomerId = null;

/* ------------------ Auth ------------------ */
$('loginBtn').addEventListener('click', async ()=>{
  const email = $('loginEmail').value.trim();
  const pass = $('loginPassword').value.trim();
  if(!email||!pass) return toast('Enter email & password','error');
  try{
    await auth.signInWithEmailAndPassword(email,pass);
  }catch(e){ toast(e.message,'error'); }
});
$('logoutBtn').addEventListener('click',()=>auth.signOut());

auth.onAuthStateChanged(async (u)=>{
  currentUser = u;
  if(!u){
    show($('loginContainer'), true);
    show($('appContainer'), false);
    return;
  }
  $('userInfo').textContent = u.email || '';
  show($('loginContainer'), false);
  show($('appContainer'), true);

  // Load settings once; also listen live
  db.collection('meta').doc('settings').onSnapshot(s=>{
    if(s.exists) settings = { name:'Techverse Solution', address:'', contact:'', gst:'', gstPercent:0, printMode:'normal', logo:'', ...s.data() };
    updateSettingsUI();
  });

  // Live products
  db.collection('products').where('deleted','!=',true).onSnapshot(q=>{
    products = q.docs.map(d=>({id:d.id,...d.data()}));
    renderProductsTable(products);
    populatePOSProducts();
    updateDashboard();
  });

  // Live customers
  db.collection('customers').onSnapshot(q=>{
    customers = q.docs.map(d=>({id:d.id,...d.data()}));
    renderCustomersTable(customers);
    updateDashboard();
  });

  // Recent transactions
  db.collection('transactions').orderBy('createdAt','desc').limit(300).onSnapshot(q=>{
    transactions = q.docs.map(d=>({id:d.id,...d.data()}));
    renderRecentTransactions();
    renderReports();
    updateDashboard();
  });
});

/* ------------------ Tabs ------------------ */
function switchTab(evt, tabName){
  document.querySelectorAll('.tab-content').forEach(el=>el.classList.remove('active'));
  document.querySelectorAll('.nav-tab').forEach(el=>el.classList.remove('active'));
  $(tabName).classList.add('active');
  evt.target.classList.add('active');
}

/* ------------------ Dashboard ------------------ */
function updateDashboard(){
  $('totalProducts').textContent = products.length;
  $('totalCustomers').textContent = customers.length;
  const total = transactions.reduce((a,t)=>a+(t.total||0),0);
  $('totalSales').textContent = total.toFixed(2);
  const low = products.filter(p => (p.quantity ?? 0) < 10);
  $('lowStockCount').textContent = low.length;

  $('lowStockTable').innerHTML = low.map(p=>`
    <tr><td>${p.name}</td><td>${p.category||'-'}</td><td><span class="low-stock">${p.quantity ?? 0}</span></td><td>${p.sku||'-'}</td></tr>
  `).join('') || '<tr><td colspan="4" style="text-align:center;">All products well stocked</td></tr>';
}
function renderRecentTransactions(){
  $('recentTransactions').innerHTML = transactions.slice(0,5).map(t=>`
    <tr>
      <td>${t.invoiceNumber || (t.id?.slice(-8) || '')}</td>
      <td>${t.createdAt?.toDate ? t.createdAt.toDate().toLocaleString() : '-'}</td>
      <td>${t.customer?.name || 'Walk-in'} (${t.customer?.phone||'-'})</td>
      <td>₹${(t.total||0).toFixed(2)}</td>
      <td><button class="btn btn-sm btn-primary" onclick="viewFirestoreInvoice('${t.id}')">View</button></td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center;">No transactions yet</td></tr>';
}

/* ------------------ Products ------------------ */
function showAddProductModal(){
  editingProductId = null;
  $('productModalTitle').textContent = 'Add Product';
  $('productName').value = '';
  $('productCategory').value = '';
  $('productQuantity').value = 0;
  $('productCost').value = 0;
  $('productSelling').value = 0;
  $('productSupplier').value = '';
  $('productSKU').value = '';
  $('productModal').classList.add('active');
}
function closeProductModal(){ $('productModal').classList.remove('active'); }
async function saveProduct(){
  const name = $('productName').value.trim();
  const category = $('productCategory').value.trim();
  const quantity = Number($('productQuantity').value || 0);
  const cost = Number($('productCost').value || 0);
  const selling = Number($('productSelling').value || 0);
  const supplier = $('productSupplier').value.trim();
  const sku = $('productSKU').value.trim();
  if(!name || !category || quantity<0 || cost<0 || selling<0) return toast('Fill all required fields correctly!','error');

  const payload = { name, category, quantity, cost, selling, supplier, sku, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
  try{
    if(editingProductId){
      await db.collection('products').doc(editingProductId).update(payload);
      toast('Product updated');
    }else{
      await db.collection('products').add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      toast('Product added');
    }
    closeProductModal();
  }catch(e){ toast(e.message,'error'); }
}
function renderProductsTable(list){
  $('productsTable').innerHTML = list.map(p=>`
    <tr>
      <td>${p.name}</td>
      <td>${p.category||'-'}</td>
      <td>${(p.quantity??0) < 10 ? '<span class="low-stock">'+(p.quantity??0)+'</span>' : (p.quantity??0)}</td>
      <td>₹${Number(p.cost||0).toFixed(2)}</td>
      <td>₹${Number(p.selling||0).toFixed(2)}</td>
      <td>${p.supplier||'-'}</td>
      <td>${p.sku||'-'}</td>
      <td class="actions">
        <button class="btn btn-sm btn-primary" onclick="editProduct('${p.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteProduct('${p.id}')">Delete</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="8" style="text-align:center;">No products found</td></tr>';
}
function searchProducts(){
  const term = $('productSearch').value.toLowerCase();
  renderProductsTable(products.filter(p =>
    (p.name||'').toLowerCase().includes(term) ||
    (p.category||'').toLowerCase().includes(term) ||
    (p.sku||'').toLowerCase().includes(term)
  ));
}
function editProduct(id){
  const p = products.find(x=>x.id===id); if(!p) return;
  editingProductId = id;
  $('productModalTitle').textContent = 'Edit Product';
  $('productName').value = p.name||'';
  $('productCategory').value = p.category||'';
  $('productQuantity').value = p.quantity ?? 0;
  $('productCost').value = p.cost ?? 0;
  $('productSelling').value = p.selling ?? 0;
  $('productSupplier').value = p.supplier||'';
  $('productSKU').value = p.sku||'';
  $('productModal').classList.add('active');
}
async function deleteProduct(id){
  if(!confirm('Delete this product?')) return;
  try{
    await db.collection('products').doc(id).update({ deleted:true, updatedAt: firebase.firestore.FieldValue.serverTimestamp() });
    toast('Product deleted');
  }catch(e){ toast(e.message,'error'); }
}

/* ------------------ Customers ------------------ */
function showAddCustomerModal(){
  editingCustomerId = null;
  $('customerModalTitle').textContent = 'Add Customer';
  $('customerName').value = '';
  $('customerContact').value = '';
  $('customerAddress').value = '';
  $('customerModal').classList.add('active');
}
function closeCustomerModal(){ $('customerModal').classList.remove('active'); }
async function saveCustomer(){
  const name = $('customerName').value.trim();
  const contact = $('customerContact').value.trim();
  const address = $('customerAddress').value.trim();
  if(!name || !contact) return toast('Please fill required fields','error');
  const payload = { name, contact, address, totalPurchases: 0, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
  try{
    if(editingCustomerId){
      await db.collection('customers').doc(editingCustomerId).set(payload,{merge:true});
      toast('Customer updated');
    }else{
      await db.collection('customers').add({ ...payload, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
      toast('Customer added');
    }
    closeCustomerModal();
  }catch(e){ toast(e.message,'error'); }
}
function renderCustomersTable(list){
  $('customersTable').innerHTML = list.map(c=>`
    <tr>
      <td>${c.name}</td>
      <td>${c.contact||'-'}</td>
      <td>${c.address||'-'}</td>
      <td>₹${Number(c.totalPurchases||0).toFixed(2)}</td>
      <td class="actions">
        <button class="btn btn-sm btn-primary" onclick="editCustomer('${c.id}')">Edit</button>
        <button class="btn btn-sm btn-danger" onclick="deleteCustomer('${c.id}')">Delete</button>
      </td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center;">No customers found</td></tr>';
}
function searchCustomers(){
  const term = $('customerSearch').value.toLowerCase();
  renderCustomersTable(customers.filter(c =>
    (c.name||'').toLowerCase().includes(term) ||
    (c.contact||'').toLowerCase().includes(term)
  ));
}
function editCustomer(id){
  const c = customers.find(x=>x.id===id); if(!c) return;
  editingCustomerId = id;
  $('customerModalTitle').textContent = 'Edit Customer';
  $('customerName').value = c.name||'';
  $('customerContact').value = c.contact||'';
  $('customerAddress').value = c.address||'';
  $('customerModal').classList.add('active');
}
async function deleteCustomer(id){
  if(!confirm('Delete this customer?')) return;
  try{
    await db.collection('customers').doc(id).delete();
    toast('Customer deleted');
  }catch(e){ toast(e.message,'error'); }
}

/* ------------------ POS / Cart / Transactions ------------------ */
function populatePOSProducts(){
  $('posProductSelect').innerHTML = '<option value="">-- Select Product --</option>' +
    products.filter(p => (p.quantity??0) > 0).map(p =>
      `<option value="${p.id}">${p.name} - ₹${Number(p.selling||0).toFixed(2)} (Stock: ${p.quantity??0})</option>`
    ).join('');
}
function addToCart(){
  const id = $('posProductSelect').value;
  if(!id) return;
  const p = products.find(x=>x.id===id); if(!p) return;
  const ex = cart.find(i=>i.id===id);
  if(ex){
    if(ex.quantity < (p.quantity??0)) ex.quantity++;
    else return toast('Not enough stock!','error');
  }else{
    cart.push({ id:p.id, name:p.name, price:Number(p.selling||0), quantity:1, maxQuantity:(p.quantity??0) });
  }
  $('posProductSelect').value = '';
  updateCart();
}
function removeFromCart(idx){ cart.splice(idx,1); updateCart(); }
function updateCartQuantity(idx, change){
  const item = cart[idx]; if(!item) return;
  const newQ = item.quantity + change;
  if(newQ<=0) removeFromCart(idx);
  else if(newQ<=item.maxQuantity){ item.quantity=newQ; updateCart(); }
  else toast('Not enough stock!','error');
}
function updateCart(){
  $('cartItems').innerHTML = cart.map((item,idx)=>`
    <tr>
      <td>${item.name}</td>
      <td>₹${item.price.toFixed(2)}</td>
      <td>
        <div class="quantity-control">
          <button onclick="updateCartQuantity(${idx},-1)">-</button>
          <span>${item.quantity}</span>
          <button onclick="updateCartQuantity(${idx},1)">+</button>
        </div>
      </td>
      <td>₹${(item.price*item.quantity).toFixed(2)}</td>
      <td><button class="btn btn-sm btn-danger" onclick="removeFromCart(${idx})">Remove</button></td>
    </tr>
  `).join('') || '<tr><td colspan="5" style="text-align:center;">Cart is empty</td></tr>';

  const subtotal = cart.reduce((s,i)=>s + i.price*i.quantity, 0);
  const taxPercentInput = Number($('taxPercent').value || 0);
  const taxAmount = subtotal * (taxPercentInput/100);
  const discount = Number($('discountAmount').value || 0);
  const grandTotal = subtotal + taxAmount - discount;

  $('subtotal').textContent = currency(subtotal);
  $('taxAmount').textContent = currency(taxAmount);
  $('discount').textContent = currency(discount);
  $('grandTotal').textContent = currency(grandTotal);
}
function clearCart(){
  cart = [];
  $('taxPercent').value = settings.gstPercent || 0;
  $('discountAmount').value = 0;
  $('custName').value = '';
  $('custPhone').value = '';
  updateCart();
}

// Complete sale: writes to transactions, updates stock, ensures customer exists, prints invoice
async function completeSale(){
  if(cart.length===0) return toast('Cart is empty','error');
  const custName = $('custName').value.trim() || 'Walk-in';
  const custPhone = $('custPhone').value.trim();

  const items = cart.map(it=>{
    const p = products.find(x=>x.id===it.id) || {};
    return { productId: it.id, name: it.name, qty: it.quantity, price: it.price, cost: Number(p.cost||0) };
  });

  const subtotal = cart.reduce((s,i)=>s+i.price*i.quantity,0);
  const taxPercent = Number($('taxPercent').value || settings.gstPercent || 0);
  const taxAmount = subtotal*(taxPercent/100);
  const discount = Number($('discountAmount').value || 0);
  const total = subtotal + taxAmount - discount;
  const paymentMode = $('paymentMode').value;

  // ensure customer in Firestore (by phone match, else by name)
  let customerRef = null;
  try{
    if(custPhone){
      const qs = await db.collection('customers').where('contact','==',custPhone).limit(1).get();
      if(!qs.empty) customerRef = db.collection('customers').doc(qs.docs[0].id);
    }
    if(!customerRef){
      const qs2 = await db.collection('customers').where('name','==',custName).limit(1).get();
      if(!qs2.empty) customerRef = db.collection('customers').doc(qs2.docs[0].id);
    }
    if(!customerRef){
      const newC = await db.collection('customers').add({
        name: custName, contact: custPhone||'', address:'', totalPurchases:0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      });
      customerRef = newC;
    }
    // bump totalPurchases
    await customerRef.set({ totalPurchases: firebase.firestore.FieldValue.increment(total) }, { merge:true });
  }catch(e){ console.warn('Customer ensure error',e); }

  // write transaction
  const tx = {
    invoiceNumber: 'INV-'+Date.now(),
    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
    items, subtotal, taxPercent, taxAmount, discount, total, paymentMode,
    customer: { name: custName, phone: custPhone||'' },
    settingsSnapshot: { name: settings.name, address: settings.address, contact: settings.contact, gst: settings.gst, logo: settings.logo, printMode: settings.printMode }
  };
  try{
    const docRef = await db.collection('transactions').add(tx);
    // update stock
    for(const it of items){
      const pref = db.collection('products').doc(it.productId);
      await pref.update({ quantity: firebase.firestore.FieldValue.increment(-it.qty), soldQuantity: firebase.firestore.FieldValue.increment(it.qty) });
    }
    toast('Sale completed');
    renderInvoice(tx, docRef.id);
    showInvoiceModal();
    clearCart();
  }catch(e){ toast(e.message,'error'); }
}

/* ------------------ Invoice / Print ------------------ */
function showInvoiceModal(){ $('invoiceModal').classList.add('active'); }
function closeInvoiceModal(){ $('invoiceModal').classList.remove('active'); }
function renderInvoice(tx, id){
  const itemsHtml = tx.items.map(it=>`
    <tr>
      <td>${it.name}</td>
      <td>${it.qty}</td>
      <td>₹${Number(it.price||0).toFixed(2)}</td>
      <td>₹${(it.qty*it.price).toFixed(2)}</td>
    </tr>
  `).join('');

  const headerName = settings.name || 'Techverse Solution';
  const logo = settings.logo ? `<img src="${settings.logo}" alt="logo" style="max-height:60px;margin-bottom:8px">` : '';
  const dateStr = new Date().toLocaleString();

  const html = `
    <div class="invoice">
      <div class="invoice-header">
        ${logo}
        <h1>${headerName}</h1>
        <p>${settings.address||''}</p>
        <p>Contact: ${settings.contact||''} ${settings.gst?(' • GST: '+settings.gst):''}</p>
      </div>
      <div class="invoice-details">
        <div>
          <strong>Invoice #:</strong> ${tx.invoiceNumber}<br>
          <strong>Date:</strong> ${dateStr}<br>
          <strong>Customer:</strong> ${tx.customer?.name || ''}<br>
          <strong>Phone:</strong> ${tx.customer?.phone || ''}<br>
        </div>
        <div style="text-align:right;">
          <strong>Total Amount</strong><br>
          <span style="font-size:24px;color:#2563eb;">₹${Number(tx.total||0).toFixed(2)}</span>
        </div>
      </div>
      <table>
        <thead><tr><th>Product</th><th>Quantity</th><th>Price (₹)</th><th>Subtotal (₹)</th></tr></thead>
        <tbody>${itemsHtml}</tbody>
      </table>
      <div style="margin-top:20px;text-align:right;">
        <div style="margin-bottom:8px;"><strong>Subtotal:</strong> ₹${Number(tx.subtotal||0).toFixed(2)}</div>
        <div style="margin-bottom:8px;"><strong>Tax (${Number(tx.taxPercent||0)}%):</strong> ₹${Number(tx.taxAmount||0).toFixed(2)}</div>
        <div style="margin-bottom:8px;"><strong>Discount:</strong> ₹${Number(tx.discount||0).toFixed(2)}</div>
        <div style="font-size:20px;color:#2563eb;"><strong>Grand Total:</strong> ₹${Number(tx.total||0).toFixed(2)}</div>
      </div>
      <div style="margin-top:40px;text-align:center;color:#666;font-size:12px;">
        <p>Thank you for your business!</p>
      </div>
    </div>
  `;
  $('invoiceContent').innerHTML = html;

  // prepare print doc (thermal/normal)
  const root = $('printRoot');
  root.classList.remove('thermal','normal');
  root.classList.add(settings.printMode==='thermal' ? 'thermal' : 'normal');
  $('printBill').innerHTML = `
    <div style="text-align:center;margin-bottom:8px;">
      ${settings.logo ? `<img src="${settings.logo}" style="max-height:60px;margin-bottom:6px">` : ''}
      <div style="font-weight:700">${headerName}</div>
      <div style="font-size:12px">${settings.address||''}</div>
      <div style="font-size:12px">Contact: ${settings.contact||''}${settings.gst?(' • GST: '+settings.gst):''}</div>
      <div style="font-size:12px">Invoice: ${tx.invoiceNumber} • ${dateStr}</div>
      <div style="font-size:12px">Customer: ${tx.customer?.name||''} (${tx.customer?.phone||''})</div>
    </div>
    <hr/>
    <table style="width:100%;font-size:12px">
      <thead><tr><th style="text-align:left">Item</th><th style="text-align:right">Qty</th><th style="text-align:right">Price</th><th style="text-align:right">Amt</th></tr></thead>
      <tbody>
        ${tx.items.map(it=>`<tr>
          <td>${it.name}</td><td style="text-align:right">${it.qty}</td><td style="text-align:right">${it.price.toFixed(2)}</td><td style="text-align:right">${(it.qty*it.price).toFixed(2)}</td>
        </tr>`).join('')}
      </tbody>
    </table>
    <hr/>
    <div style="display:flex;justify-content:space-between;font-size:12px"><span>Discount</span><span>${Number(tx.discount||0).toFixed(2)}</span></div>
    <div style="display:flex;justify-content:space-between;font-size:12px"><span>Tax (${Number(tx.taxPercent||0)}%)</span><span>${Number(tx.taxAmount||0).toFixed(2)}</span></div>
    <div style="display:flex;justify-content:space-between;font-weight:700;font-size:14px;margin-top:4px"><span>Total</span><span>${Number(tx.total||0).toFixed(2)}</span></div>
    <div style="text-align:center;font-size:12px;margin-top:6px">Thank you!</div>
  `;
}
async function viewFirestoreInvoice(id){
  const doc = await db.collection('transactions').doc(id).get();
  if(!doc.exists) return toast('Invoice not found','error');
  renderInvoice(doc.data(), id);
  showInvoiceModal();
}
function printInvoice(){
  // show print root, trigger print, then hide
  $('printRoot').style.display = '';
  window.print();
  $('printRoot').style.display = 'none';
}

/* ------------------ Reports ------------------ */
function renderReports(){
  // last 6 months sales
  const now = new Date();
  const last6 = [];
  for(let i=5;i>=0;i--){
    const d = new Date(now.getFullYear(), now.getMonth()-i, 1);
    const m = d.getMonth(), y = d.getFullYear();
    const sum = transactions
      .filter(t => t.createdAt?.toDate && t.createdAt.toDate().getMonth()===m && t.createdAt.toDate().getFullYear()===y)
      .reduce((a,b)=>a+(b.total||0),0);
    last6.push({ month: d.toLocaleString('default',{month:'short'}), sales: sum });
  }
  svgChart('salesChart', last6);

  // best sellers
  const soldMap = {}; // productId -> {name, category, qty, revenue}
  transactions.forEach(t=>{
    (t.items||[]).forEach(it=>{
      if(!soldMap[it.productId]) soldMap[it.productId] = { name: it.name, category:'', qty:0, revenue:0 };
      soldMap[it.productId].qty += it.qty;
      soldMap[it.productId].revenue += it.qty*it.price;
    });
  });
  const best = Object.values(soldMap).sort((a,b)=>b.qty-a.qty).slice(0,10);
  $('bestSellersTable').innerHTML = best.map(b=>`
    <tr><td>${b.name}</td><td>${b.category||'-'}</td><td>${b.qty}</td><td>₹${b.revenue.toFixed(2)}</td></tr>
  `).join('') || '<tr><td colspan="4" style="text-align:center;">No sales data available</td></tr>';

  // month summary
  const thisMonth = new Date().getMonth();
  const thisYear = new Date().getFullYear();
  const monthTx = transactions.filter(t=>t.createdAt?.toDate && t.createdAt.toDate().getMonth()===thisMonth && t.createdAt.toDate().getFullYear()===thisYear);
  const monthRevenue = monthTx.reduce((a,b)=>a+(b.total||0),0);
  $('monthRevenue').textContent = monthRevenue.toFixed(2);
  $('monthTransactions').textContent = monthTx.length;
  $('avgSale').textContent = monthTx.length ? (monthRevenue/monthTx.length).toFixed(2) : '0';
}

/* ------------------ Export / Import (Firestore JSON) ------------------ */
async function exportData(kind){
  try{
    const col = await db.collection(kind).get();
    const data = col.docs.map(d=>({ id:d.id, ...d.data(), createdAt: undefined, updatedAt: undefined }));
    const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `techverse_${kind}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){ toast(e.message,'error'); }
}
async function exportAll(){
  try{
    const [p,c,t] = await Promise.all([
      db.collection('products').get(),
      db.collection('customers').get(),
      db.collection('transactions').get(),
    ]);
    const payload = {
      products: p.docs.map(d=>({id:d.id,...d.data()})),
      customers: c.docs.map(d=>({id:d.id,...d.data()})),
      transactions: t.docs.map(d=>({id:d.id,...d.data()})),
      settings
    };
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `techverse_all.json`;
    a.click();
    URL.revokeObjectURL(a.href);
  }catch(e){ toast(e.message,'error'); }
}
async function importData(){
  const type = $('importType').value;
  const file = $('importFile').files[0];
  if(!file) return toast('Choose a file','error');
  try{
    const txt = await file.text();
    const data = JSON.parse(txt);
    if(!Array.isArray(data)) return toast('Invalid JSON format for collection','error');
    const batch = db.batch();
    data.forEach(row=>{
      const id = row.id ? String(row.id) : undefined;
      const ref = id ? db.collection(type).doc(id) : db.collection(type).doc();
      const { id:_, ...doc } = row;
      batch.set(ref, doc, { merge:true });
    });
    await batch.commit();
    toast('Imported successfully');
    $('importFile').value = '';
  }catch(e){ toast(e.message,'error'); }
}

/* ------------------ Settings (meta/settings) ------------------ */
function updateSettingsUI(){
  $('setName').value = settings.name || 'Techverse Solution';
  $('setAddress').value = settings.address || '';
  $('setContact').value = settings.contact || '';
  $('setGST').value = settings.gst || '';
  $('setGSTPercent').value = settings.gstPercent || 0;
  $('setPrintMode').value = settings.printMode || 'normal';
  if(settings.logo){
    $('logoPreview').src = settings.logo;
    $('logoPreview').style.display = '';
  }else{
    $('logoPreview').style.display = 'none';
  }
  // default tax percent for POS
  if(!$('taxPercent').value) $('taxPercent').value = settings.gstPercent || 0;
}
function reloadSettings(){ db.collection('meta').doc('settings').get().then(s=>{ if(s.exists){ settings={...settings,...s.data()}; updateSettingsUI(); } }); }
async function saveSettings(){
  // handle logo upload first if chosen
  let logoUrl = settings.logo || '';
  const file = $('setLogoFile').files[0];
  if(file){
    try{
      const ref = storage.ref().child(`logos/${Date.now()}_${file.name}`);
      await ref.put(file);
      logoUrl = await ref.getDownloadURL();
    }catch(e){ toast('Logo upload failed: '+e.message,'error'); return; }
  }
  const payload = {
    name: $('setName').value.trim() || 'Techverse Solution',
    address: $('setAddress').value.trim(),
    contact: $('setContact').value.trim(),
    gst: $('setGST').value.trim(),
    gstPercent: Number($('setGSTPercent').value || 0),
    printMode: $('setPrintMode').value,
    logo: logoUrl
  };
  try{
    await db.collection('meta').doc('settings').set(payload, { merge: true });
    toast('Settings saved');
  }catch(e){ toast(e.message,'error'); }
}

/* ------------------ Misc Init ------------------ */
function showAddCustomerOnPOS(name, phone){
  $('custName').value = name || '';
  $('custPhone').value = phone || '';
}
function showToast(message,type){ toast(message,type); }

/* ------------------ Invoice print via view button ------------------ */
function printFromView(){ printInvoice(); }

/* ------------------ Init defaults ------------------ */
(function init(){
  // nothing else; waits for auth listener
})();
</script>
</body>
</html>
